!function(e){var t=function(e){this._res=e,this._isFulfilled=!!arguments.length,this._isRejected=!1,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[]};t.prototype={valueOf:function(){return this._res},isFulfilled:function(){return this._isFulfilled},isRejected:function(){return this._isRejected},isResolved:function(){return this._isFulfilled||this._isRejected},fulfill:function(e){this.isResolved()||(this._isFulfilled=!0,this._res=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=i)},reject:function(e){this.isResolved()||(this._isRejected=!0,this._res=e,this._callCallbacks(this._rejectedCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=i)},notify:function(e){this.isResolved()||this._callCallbacks(this._progressCallbacks,e)},then:function(e,r,n,o){r&&!s(r)?(o=r,r=i):n&&!s(n)&&(o=n,n=i);var a,l=new t;return this._isRejected||(a={promise:l,fn:s(e)?e:i,ctx:o},this._isFulfilled?this._callCallbacks([a],this._res):this._fulfilledCallbacks.push(a)),this._isFulfilled||(a={promise:l,fn:r,ctx:o},this._isRejected?this._callCallbacks([a],this._res):this._rejectedCallbacks.push(a)),this.isResolved()||this._progressCallbacks.push({promise:l,fn:n,ctx:o}),l},fail:function(e,t){return this.then(i,e,t)},always:function(e,t){var i=this,r=function(){return e.call(this,i)};return this.then(r,r,t)},progress:function(e,t){return this.then(i,i,e,t)},spread:function(e,t,i){return this.then(function(t){return e.apply(this,t)},t,i)},done:function(e,t,i,r){this.then(e,t,i,r).fail(o)},delay:function(e){var i,r=this.then(function(r){var n=new t;return i=setTimeout(function(){n.fulfill(r)},e),n});return r.always(function(){clearTimeout(i)}),r},timeout:function(e){var i=new t,r=setTimeout(function(){i.reject(Error("timed out"))},e);return i.sync(this),i.always(function(){clearTimeout(r)}),i},sync:function(e){e.then(this.fulfill,this.reject,this.notify,this)},_callCallbacks:function(e,t){var i=e.length;if(i){var o=this.isResolved(),s=this.isFulfilled();n(function(){for(var n,a,l,u=0;i>u;)if(n=e[u++],a=n.promise,l=n.fn){var p,h=n.ctx;try{p=h?l.call(h,t):l(t)}catch(d){a.reject(d);continue}o?r.isPromise(p)?function(e){p.then(function(t){e.fulfill(t)},function(t){e.reject(t)},function(t){e.notify(t)})}(a):a.fulfill(p):a.notify(p)}else o?s?a.fulfill(t):a.reject(t):a.notify(t)})}}};var i,r={Promise:t,promise:function(e){return arguments.length?r.isPromise(e)?e:new t(e):new t},when:function(e,t,i,n,o){return r.promise(e).then(t,i,n,o)},fail:function(e,t,n){return r.when(e,i,t,n)},always:function(e,t,i){return r.promise(e).always(t,i)},progress:function(e,t,i){return r.promise(e).progress(t,i)},spread:function(e,t,i,n){return r.promise(e).spread(t,i,n)},done:function(e,t,i,n,o){r.promise(e).done(t,i,n,o)},isPromise:function(e){return e&&s(e.then)},valueOf:function(e){return r.isPromise(e)?e.valueOf():e},isFulfilled:function(e){return r.isPromise(e)?e.isFulfilled():!0},isRejected:function(e){return r.isPromise(e)?e.isRejected():!1},isResolved:function(e){return r.isPromise(e)?e.isResolved():!0},fulfill:function(e){return r.when(e,i,function(e){return e})},reject:function(e){return r.when(e,function(e){var i=new t;return i.reject(e),i})},resolve:function(e){return r.isPromise(e)?e:r.when(e)},invoke:function(t){try{return r.promise(t.apply(e,a.call(arguments,1)))}catch(i){return r.reject(i)}},forEach:function(e,t,i,n){for(var o=n?n.length:e.length,s=0;o>s;)r.when(e[n?n[s]:s],t,i),++s},all:function(e){var i=new t,n=u(e),o=n?p(e):h(e),s=o.length,a=n?[]:{};if(!s)return i.fulfill(a),i;var l=s,d=function(){if(!--l){for(var t=0;s>t;)a[o[t]]=r.valueOf(e[o[t++]]);i.fulfill(a)}},c=function(e){i.reject(e)};return r.forEach(e,d,c,o),i},allResolved:function(e){var i=new t,n=u(e),o=n?p(e):h(e),s=o.length,a=n?[]:{};if(!s)return i.fulfill(a),i;var l=function(){--s||i.fulfill(e)};return r.forEach(e,l,l,o),i},allPatiently:function(e){return r.allResolved(e).then(function(){var t,i,n,o,s=u(e),a=s?p(e):h(e),l=a.length,d=0;if(!l)return s?[]:{};for(;l>d;)n=a[d++],o=e[n],r.isRejected(o)?(t||(t=s?[]:{}),s?t.push(o.valueOf()):t[n]=o.valueOf()):t||((i||(i=s?[]:{}))[n]=r.valueOf(o));if(t)throw t;return i})},any:function(e){var i=new t,n=e.length;if(!n)return i.reject(Error()),i;var o,s=0,a=function(e){i.fulfill(e)},l=function(e){s||(o=e),++s===n&&i.reject(o)};return r.forEach(e,a,l),i},delay:function(e,t){return r.promise(e).delay(t)},timeout:function(e,t){return r.promise(e).timeout(t)}},n=function(){var t=[],i=function(e){return 1===t.push(e)},r=function(){var e=t,i=0,r=t.length;for(t=[];r>i;)e[i++]()};if("function"==typeof setImmediate)return function(e){i(e)&&setImmediate(r)};if("object"==typeof process&&process.nextTick)return function(e){i(e)&&process.nextTick(r)};if(e.postMessage){var n=!0;if(e.attachEvent){var o=function(){n=!1};e.attachEvent("onmessage",o),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",o)}if(n){var s="__promise"+ +new Date,a=function(e){e.data===s&&(e.stopPropagation&&e.stopPropagation(),r())};return e.addEventListener?e.addEventListener("message",a,!0):e.attachEvent("onmessage",a),function(t){i(t)&&e.postMessage(s,"*")}}}var l=e.document;if("onreadystatechange"in l.createElement("script")){var u=function(){var e=l.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,r()},(l.documentElement||l.body).appendChild(e)};return function(e){i(e)&&u()}}return function(e){i(e)&&setTimeout(r,0)}}(),o=function(e){n(function(){throw e})},s=function(e){return"function"==typeof e},a=Array.prototype.slice,l=Object.prototype.toString,u=Array.isArray||function(e){return"[object Array]"===l.call(e)},p=function(e){for(var t=[],i=0,r=e.length;r>i;)t.push(i++);return t},h=Object.keys||function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(i);return t},d=!0;"object"==typeof exports&&(module.exports=r,d=!1),"object"==typeof modules&&(modules.define("vow",function(e){e(r)}),d=!1),"function"==typeof define&&(define(function(e,t,i){i.exports=r}),d=!1),d&&(e.Vow=r)}(this),Vow.Promise.prototype.__reject=Vow.Promise.prototype.reject,Vow.Promise.prototype.reject=function(e){e instanceof Error&&ns.log.exception("promise.exception",e),this.__reject(e)},function(e,t){"use strict";var i={};i.de="undefined"==typeof e,i.inherit=function(e,t,r){var n=function(){};n.prototype=t.prototype;var o=e.prototype=new n;if(r)if(Array.isArray(r))for(var s=0,a=r.length;a>s;s++)i.extend(o,r[s]);else i.extend(o,r);return o.super_=t.prototype,o.constructor=e,e},i.extend=function(e){for(var t=1,i=arguments.length;i>t;t++){var r=arguments[t];for(var n in r)e[n]=r[n]}return e},i.nop=function(){},i.true=function(){return!0},i.false=function(){return!1},i.value=function(e){return function(){return e}},i.logger=function(e){return e?function(){var t=[].slice.call(arguments);console.log.apply(null,[e].concat(t))}:console.log},i.next=i.de?function(e){process.nextTick(e)}:function(e){setTimeout(e,0)},i.de&&(module.exports=i);var i=i||require("./no.base.js");i.Parser=function(e,t){this._rules=e,this._tokens=t||{}},i.Parser.prototype.start=function(e,t){this.input=e,this.p=0,this.s=e;var i=this.parse(t);return this.s&&this.error("End of string expected"),i},i.Parser.prototype.parse=function(e,t){var i=this._rules[e],r=this.p,n=i.call(this,t);return n._start=r,n._end=this.p,n._input=this.input,n},i.Parser.prototype.test=function(e){var t=this._tokens[e];if(t){var i=t.exec(this.s);return i&&i[0]}return this.la(e.length)===e?e:void 0},i.Parser.prototype.match=function(e){var t=this.test(e);return t||this.error("Token "+e+" expected"),this.move(t.length),t},i.Parser.prototype.la=function(e){return this.s.substr(0,e||1)},i.Parser.prototype.move=function(e){e||(e=1),this.s=this.s.substr(e),this.p+=e},i.Parser.prototype.skip=function(){var e=/^\s+/.exec(this.s);e&&this.move(e[0].length)},i.Parser.prototype.error=function(e){throw Error(e+" at "+this.p+": "+this.s)};var i=i||require("./no.base.js");i.de&&(require("./no.parser.js"),module.exports=i),function(){function e(e){this.data=e}function t(t,i){if(i instanceof e)return r(i,t.scalar());for(var n=i.nodes,o=t.scalar(),s=0;s<n.length;s++)if(o==n[s].scalar())return!0;return!1}function r(t,i){var r=t.data;if(Array.isArray(r)){for(var n=0;n<r.length;n++)if(new e(r[n]).scalar()==i)return!0;return!1}return t.scalar()==i}function n(){this.nodes=[]}function o(e,t){var i=e+"::"+t,r=V[i];return r||(r=V[i]=l(w.start(e,t))),r}function s(e){var t={};for(var r in e)t[r]=i.jpath.expr(e[r]);return function(e,r,n){var o={};for(var s in t)o[s]=i.jpath.toScalar(t[s](e,r,n));return o}}function a(e){for(var t=[],r=e.length,n=0;r>n;n++)t.push(i.jpath.expr(e[n]));return function(e,n,o){for(var s=[],a=0;r>a;a++)s.push(i.jpath.toScalar(t[a](e,n,o)));return s}}function l(e){for(var t=[],r="jpath"===e._id?p(e,t):u(e,t),n="",o=0;r>=o;o++)n+="function t"+o+"(node, root, vars, funcs) {\n"+t[o]+"\n}\n\n";return n+="return function(data, vars, funcs) {\nvar node = new no.JNode(data);\nreturn t"+r+"(node, node, vars, funcs);\n}\n",Function("no",n)(i)}function u(e,t){var i="return ("+h(e,t)+");";return t.push(i)-1}function p(e,t){var i="";e.abs&&(i+="node = root;\n");for(var r=e.steps,n=0,o=r.length;o>n;n++){var s=r[n],a=s._id;switch(a){case"nametest":i+='node = node.nametest("'+s.nametest+'");\n';break;case"star":i+="node = node.startest();\n";break;case"pred":case"index":s.expr._as="pred"===a?v:c;var l=u(s.expr,t);i+="node = node."+a+"(t"+l+", root, vars, funcs);\n";break;case"guard":i+="if (!("+h(s.expr,t)+")) { return node.empty; }\n"}"guard"!==a&&(i+="if (node.isEmpty()) { return node.empty; }\n")}return i+="return node;",t.push(i)-1}function h(e,t){var i;switch(e._id){case"root":i="root";break;case"self":i="node";break;case"number":i=e.value;break;case"string_literal":i=JSON.stringify(e.value);break;case"string":i="("+e.value.map(function(e){return e._as=c,h(e,t)}).join(" + ")+")";break;case"var":i='(new no.JNode(vars["'+e.name+'"]))';break;case"func":i='funcs["'+e.name+'"](';for(var r=0,n=e.args.length;n>r;r++){var o=e.args[r];o._as=c,i+=r?",":"",i+=h(o,t)}i+=")";break;case"unop":e.expr._as="!"===e.op?v:c,i=e.op+"("+h(e.expr,t)+")";break;case"binop":var s,n=e.left,a=e.right,l=n._type,u=a._type,d=e.op;switch(d){case"&&":case"||":s=l===v&&u===v?v:c;break;case"==":case"!=":l===u||l!==v&&u!==v||(s=v);break;default:s=c}s&&(n._as=a._as=s);var y=h(n,t),_=h(a,t);if("=="===d||"!="===d){if(l===f||u===f){if(l===c){var m=_;_=y,y=m}var g=l===u?"N":"S";i="("+y+").cmp"+g+"("+_+")"}i&&"!="===d&&(i="!("+i+")")}void 0===i&&(i="("+y+" "+e.op+" "+_+")");break;case"subexpr":i="("+h(e.expr,t)+")";break;case"jpath":var w=p(e,t);i="t"+w+"(node, root, vars, funcs)";break;case"filter":var w=p(e.jpath,t);i="t"+w+'(new no.JNode(vars["'+e.name+'"]), root, vars, funcs)'}return e._as&&e._as!==e._type&&(e._type===f?i="("+i+")."+e._as+"()":e._type===c&&(i="!!("+i+")")),i}function d(e){for(var t=e.split("."),i=1,r=t.length-1,n="var r = data; var t;";r>i;i++)n+='t = r["'+t[i]+'"];',n+='if (t == null) { t = r["'+t[i]+'"] = {}; }',n+="r = t;";return n+='r["'+t[i]+'"] = value;',n+="return data;",new Function("data","value",n)}e.prototype.empty=new n,e.prototype.isEmpty=function(){return!1},e.prototype.nametest=function(t,i){var r=this.data;if(!r)return this.empty;if(Array.isArray(r)){i||(i=new n);for(var o=0;o<r.length;o++)new e(r[o]).nametest(t,i);return i}var s=r[t];if(void 0===s)return this.empty;var a=new e(s);return i?i.push(a):a},e.prototype.startest=function(t){t||(t=new n);var i=this.data;if(Array.isArray(i))for(var r=0;r<i.length;r++)new e(i[r]).startest(t);else for(var o in i)this.nametest(o,t);return t},e.prototype.pred=function(t,i,r,o){var s=this.data;if(Array.isArray(s)){for(var a=new n,l=0;l<s.length;l++){var u=new e(s[l]);t(u,i,r,o)&&a.push(u)}return a}return t(this,i,r,o)?this:this.empty},e.prototype.index=function(t,i,r,n){var o=this.data;if(Array.isArray(o)){var s=o[t(this,i,r,n)];return void 0!==s?new e(s).toNodeset():this.empty}return 0===t?this:this.empty},e.prototype.toArray=function(){return[this.data]},e.prototype.toNodeset=function(){return(new n).push(this)},e.prototype.scalar=function(){var e=this.data;return"object"==typeof e?"":e},e.prototype.boolean=function(){var e=this.data;return Array.isArray(e)?e.length>0:!!e},e.prototype.cmpN=function(i){var r=this.data;if(Array.isArray(r)){for(var n=0;n<r.length;n++)if(t(new e(r[n]),i))return!0;return!1}return t(this,i)},e.prototype.cmpS=function(e){return r(this,e)},n.prototype.empty=e.prototype.empty,n.prototype.isEmpty=function(){return!this.nodes.length},n.prototype.push=function(e){return this.nodes.push(e),this},n.prototype.nametest=function(e,t){var i=this.nodes;t||(t=new n);for(var r=0;r<i.length;r++)i[r].nametest(e,t);return t},n.prototype.startest=function(e){var t=this.nodes;e||(e=new n);for(var i=0;i<t.length;i++)t[i].startest(e);return e},n.prototype.pred=function(e,t,i,r){for(var o=this.nodes,s=new n,a=0;a<o.length;a++){var l=o[a];e(l,t,i,r)&&s.push(l)}return s},n.prototype.index=function(e){var t=this.nodes[e];return void 0!==t?(new n).push(t):this.empty},n.prototype.toArray=function(){for(var e=[],t=this.nodes,i=0;i<t.length;i++)e.push(t[i].data);return e},n.prototype.scalar=function(){var e=this.nodes;return e.length?e[0].scalar():""},n.prototype.boolean=function(){var e=this.nodes;return e.length?e[0].boolean():!1},n.prototype.cmpN=function(e){for(var t=this.nodes,i=0,r=t.length;r>i;i++)if(t[i].cmpN(e))return!0;return!1},n.prototype.cmpS=function(e){for(var t=this.nodes,i=0,r=t.length;r>i;i++)if(t[i].cmpS(e))return!0;return!1},i.JNode=e,i.JNodeset=n;var c="scalar",f="nodeset",v="boolean",y={"*":6,"/":6,"%":6,"+":5,"-":5,"<=":4,">=":4,"<":4,">":4,"==":3,"!=":3,"&&":2,"||":1},_={};_.SELF=/^\.(?![a-zA-Z_*.[])/,_.ROOT=/^\/(?![.[])/,_.BINOP=/^(?:\+|-|\*|\/|%|==|!=|<=|>=|<|>|&&|\|\|)/,_.UNOP=/^(?:\+|-|!)/,_.DIGIT=/^[0-9]/,_.ID=/^[a-zA-Z_][a-zA-Z0-9-_]*/,_.NUMBER=/^[0-9]+(?:\.[0-9]+)?/,_.CHARS=/^[^"{}\\]+/;var m={};m.expr=function(){function e(e){for(var r,n,o;(r=t[0])&&y[r]>=e;)o=i.shift(),n=i.shift(),i.unshift({_id:"binop",_type:"+-*/%".indexOf(r)>-1?c:v,_local:n._local||o._local,op:t.shift(),left:n,right:o})}var t=[],i=[this.parse("unary")];this.skip();for(var r,n=0;r=this.test("BINOP");){this.move(r.length),this.skip();var o=y[r];n>=o&&e(o),t.unshift(r),i.unshift(this.parse("unary")),this.skip(),n=o}return e(0),i[0]},m.unary=function(){var e;if(e=this.test("UNOP")){this.move();var t=this.parse("unary");return{_id:"unop",_type:"!"===e?v:c,_local:t._local,op:e,expr:t}}return this.parse("primary")},m.primary=function(){var e=this.la();switch(e){case'"':return this.parse("string");case".":case"/":return this.parse("jpath");case"(":return this.parse("subexpr")}if(this.test("DIGIT"))return{_id:"number",_type:c,value:this.match("NUMBER")};var t=this.match("ID");if(this.test("."))return{_id:"filter",_type:f,name:t,jpath:this.parse("jpath")};if(this.test("(")){this.move(),this.skip();var i=[];if(!this.test(")"))for(i.push(this.parse("expr")),this.skip();this.test(",");)this.move(),this.skip(),i.push(this.parse("expr")),this.skip();return this.match(")"),{_id:"func",_type:c,name:t,args:i}}return{_id:"var",_type:f,name:t}},m.subexpr=function(){this.move(),this.skip();var e=this.parse("expr");return this.skip(),this.match(")"),{_id:"subexpr",_type:e._type,_local:e._local,expr:e}},m.jpath=function(){if(this.test("SELF"))return this.move(),{_id:"self",_type:f,_local:!0};if(this.test("ROOT"))return this.move(),{_id:"root",_type:f};var e;this.test("/")&&(this.move(),e=!0);for(var t=[];;){var i=this.la();if("."===i)t.push(this.parse("step"));else{if("["!==i)break;var r=this.parse("pred");"guard"===r._id?t.unshift(r):t.push(r)}}return{_id:"jpath",_type:f,_local:!e,abs:e,steps:t}},m.step=function(){this.move();var e=this.la();return"["===e?this.parse("pred"):"*"===e?(this.move(),{_id:"star"}):{_id:"nametest",nametest:this.match("ID")}},m.pred=function(){this.move(),this.skip();var e=this.parse("expr");this.skip(),this.match("]");var t="index";return e._local?t="pred":e._type===v&&(t="guard"),{_id:t,expr:e}},m.string=function(){this.match('"');var e=this.parse("string_content");return this.match('"'),e};var g={"{{":"{","}}":"}",'\\"':'"',"\\\\":"\\"};m.string_content=function(){function e(){n&&(r.push(t(n)),n="")}function t(e){return{_id:"string_literal",_type:c,value:e}}for(var i,r=[],n="";this.s;)if(i=g[this.la(2)])n+=i,this.move(2);else{if(i=this.la(),'"'===i)break;"\\"===i?(n+=i,this.move()):"{"===i?(e(),this.move(),this.skip(),r.push(this.parse("expr")),this.skip(),this.match("}")):n+=this.match("CHARS")}return e(),r.length||r.push(t("")),{_id:"string",_type:c,value:r}};var w=new i.Parser(m,_),V={};i.jpath=function(e,t,r,n){return i.jpath.toScalar(i.jpath.expr(e)(t,r,n))},i.jpath.raw=function(e,t,r,n){return i.jpath.expr(e)(t,r,n)},i.jpath.scalar=function(e){var t=i.jpath.expr(e);return function(e,r,n){return i.jpath.toScalar(t(e,r,n))}},i.jpath.boolean=function(e){var t=i.jpath.expr(e);return function(e,r,n){return i.jpath.toBoolean(t(e,r,n))}},i.jpath.string=function(e){return o(e,"string_content")},i.jpath.expr=function(e){var t=typeof e;return"string"===t?o(e,"expr"):e&&"object"===t?Array.isArray(e)?a(e):s(e):function(){return e}},i.jpath.toScalar=function(t){return t instanceof e?t.data:t instanceof n?t.isEmpty()?void 0:t.toArray():t},i.jpath.toBoolean=function(t){return t instanceof e||t instanceof n?t.boolean():t};var M={};i.jpath.set=function(e,t,i){var r=M[e]||(M[e]=d(e));return r(t,i)}}();var r={};r.todo=function(){throw new Error("Unimplemented")},r.parseQuery=function(e){var t={};return e.split("&").forEach(function(i){var n=i.split("="),o=n.shift();if(o){var s=n.join("=");if("undefined"==typeof s)s="";else try{s=decodeURIComponent(s)}catch(a){s="",r.log.info("ns.parseQuery.invalid-param",{query:e,chunk:i})}o in t?(Array.isArray(t[o])||(t[o]=[t[o]]),t[o].push(s)):t[o]=s}}),t},r.renderString=function(e,t,i){return yr.run(i||"main",e,t)},r.renderNode=function(e,t,i){return r.html2node(r.renderString(e,t,i))},r.init=function(){r.action.init(),r.router.init(),r.history.init(),r.initMainView()},r.initMainView=function(){var e=r.View.create("app");e._setNode(t.getElementById("app")),e.invalidate(),r.MAIN_VIEW=e},r.assert=function(e){e||r.assert.fail.apply(this,Array.prototype.slice.call(arguments,1))},r.assert.fail=function(e,t){for(var i=Array.prototype.slice.call(arguments,2),r=0;r<i.length;r++)t=t.replace("%s",i[r]);throw new Error("["+e+"] "+t)},r.key=function(e,t){var i=e;t=t||{};for(var r in t)i+="&"+r+"="+encodeURIComponent(t[r]);return i},r.params2query=function(e){var t,i,r=[];for(t in e)if(i=e[t],Array.isArray(i))for(var n=0;n<i.length;n++)r.push(encodeURIComponent(t)+"="+encodeURIComponent(i[n]));else r.push(encodeURIComponent(t)+"="+encodeURIComponent(i));return r.join("&")},r.reset=function(){r.action&&r.action._reset(),r.router._reset(),r.layout._reset(),r.Model._reset(),r.View._reset(),r.request._reset(),r.page._reset(),r.page.history.reset(),r.MAIN_VIEW=null},r.L={},r.L.VIEW="view",r.L.ASYNC="async",r.L.BOX="box",r.V={},r.V.STATUS={NONE:"none",LOADING:"loading",OK:"ok",INVALID:"invalid"},r.M={},r.M.STATUS={ERROR:"error",INITED:"inited",NONE:"none",OK:"ok",INVALID:"invalid"},r.R={NOT_APP_URL:"ns-router-not-app",NOT_FOUND:"not-found",REDIRECT:"ns-router-redirect"},r.U={},r.U.STATUS={MODELS:"models",EXPIRED:"expired"},r.U.EXEC={GLOBAL:"global",ASYNC:"async",PARALLEL:"parallel"},r.DEBUG=!1,r.H={DEFAULTS:{dataType:"json",type:"POST"}},r.V.EVENTS={click:"click",dblclick:"dblclick",mousedown:"mousedown",mousemove:"mousemove",mouseup:"mouseup"},r.V.DOM_EVENTS=["blur","change","input","click","dblclick","dragstart","dragenter","dragover","dragleave","drag","drop","dragend","focus","focusin","focusout","keydown","keypress","keyup","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","resize","scroll","submit"],r.V.NS_EVENTS=["ns-view-async","ns-view-destroyed","ns-view-init","ns-view-htmlinit","ns-view-show","ns-view-touch","ns-view-hide","ns-view-htmldestroy"],r.IS_TOUCH=function(){return"boolean"==typeof e.NS_IS_TOUCH?e.NS_IS_TOUCH:Boolean("ontouchstart"in e||e.DocumentTouch&&t instanceof DocumentTouch)}(),r.IS_TOUCH&&(r.V.DOM_EVENTS.push("swipe","swipeleft","swiperight","tap","touchstart","touchmove","touchend"),r.V.EVENTS={click:"tap",dblclick:"doubletap",mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"}),function(e){e.replaceNode=function(e,t){return e===t?!0:e.parentNode?(e.parentNode.replaceChild(t,e),!0):!1},e.removeNode=function(e){var t=e.parentNode;t&&t.removeChild(e)},e.html2node=function(e){if(!e)return null;var i=t.createElement("div");return i.innerHTML=e,i.firstChild},e.childrenIterator=function(e){return function(e){var t=-1;return{getNext:function(){return t++,e[t]||null}}}(e.children)};var i=/[\t\r\n]/g;e.hasClass="undefined"!=typeof t&&t.createElement("div").classList?function(e,t){return e.classList.contains(t)}:function(e,t){return t=" "+t+" ",1===e.nodeType&&(" "+e.className+" ").replace(i," ").indexOf(t)>=0},e.byClass="undefined"!=typeof t&&t.getElementsByClassName?function(e,i){return i=i||t,i.getElementsByClassName(e)}:function(e,i){return i=i||t,$(i).find("."+e)}}(r),function(e){var t=/[&<>"'\/]/g,i=function(){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return function(t){return e[t]}}();e.entityify=function(e){return String(e).replace(t,i)};var r=/&([^&;]+);/g,n=function(){var e={amp:"&",lt:"<",gt:">",quot:'"',"#x27":"'","#x2F":"/"};return function(t,i){return e[i]||t}}();e.deentityify=function(e){return String(e).replace(r,n)}}(r),r.Events={},r.Events.on=function(e,t){var i=this._nsevents_handlers||(this._nsevents_handlers={});return r.assert("function"==typeof t,"ns.Events",'Handler for event "%s" in not a function.',e),(i[e]||(i[e]=[])).push(t),this},r.Events.once=function(e,t){var i=this,r=function(){i.off(e,r),t.apply(this,arguments)};return this.on(e,r),this},r.Events.off=function(e,t){var i;if(t){if(i=this._nsevents_handlers&&this._nsevents_handlers[e]){var r=i.indexOf(t);-1!==r&&i.splice(r,1)}}else i=this._nsevents_handlers,i&&(i[e]=null);return this},r.Events.trigger=function(e){var t=this._nsevents_handlers&&this._nsevents_handlers[e];if(t){t=t.slice();for(var i=0,n=t.length;n>i;i++)try{t[i].apply(this,arguments)}catch(o){r.log.exception("ns.events",o,{name:e})}}return this},r.Events.atrigger=function(){var e=this,t=arguments;i.next(function(){e.trigger.apply(e,t)})},r.Events.forward=function(e,t){return this.on(e,function(e,i){t.trigger(e,i)})},r.events=i.extend({},r.Events),function(){function i(e){return"function"==typeof e}r.history={},r.history.init=function(){$(e).on("popstate",function(e){e.preventDefault(),e.stopPropagation(),r.history.onpopstate(e)}),$(t).on(r.V.EVENTS.click,"a",r.history._onAnchorClick)},r.history.pushState=function(t,n){i(e.history.pushState)&&e.history.pushState(null,n||r.page.title(t),t)},r.history.replaceState=function(t,n){i(e.history.replaceState)&&e.history.replaceState(null,n||r.page.title(t),t)},r.history.onpopstate=function(){r.page.go("",!0)},r.history.followAnchorHref=function(e){return r.page.go(e)},r.history._onAnchorClick=function(t){var i=t.currentTarget;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return!0;if(i.hostname!==e.location.hostname)return!0;if(r.router.baseDir){var n=i.pathname,o=r.router.baseDir;if(n.substr(0,o.length)!==o)return!0}var s=i.getAttribute("href");if(!s||i.getAttribute("target"))return!0;var a=r.history.followAnchorHref(s,i);return Vow.isPromise(a)?(t.preventDefault(),!0):void 0}}(),r.http=function(e,t,n){n=i.extend({},r.H.DEFAULTS,n),n.url=e,n.data=t;var o=new Vow.Promise;return $.ajax(n).done(function(e){o.fulfill(e)}).fail(function(e,t,i){var r=i||t||"unknown error";o.reject({error:r,xhr:e})}),o},r.object={},r.object.clone=function(e){if(e&&"object"==typeof e){var t;if(Array.isArray(e)){t=[];for(var i=0;i<e.length;i++)t.push(r.object.clone(e[i]))}else{t={};for(var n in e)t[n]=r.object.clone(e[n])}return t}return e},r.object.isEmpty=function(e){for(var t in e)return!1;return!0},function(){r.profile={},r.profile.startTimer=function(e){this._profileTimes||(this._profileTimes={}),r.assert(!this._profileTimes[e],"ns.profile","Timer '%s' is in use",e),this._profileTimes[e]=Date.now()},r.profile.stopTimer=function(e){return this._profileTimes||(this._profileTimes={}),r.assert(this._profileTimes[e],"ns.profile","Timer '%s' haven't been started",e),this._profileTimes[e]=Date.now()-this._profileTimes[e],this._profileTimes[e]},r.profile.switchTimer=function(e,t){this.stopTimer(e),this.startTimer(t)},r.profile.getTimer=function(e){this._profileTimes||(this._profileTimes={});var t=this._profileTimes[e];return"number"==typeof t?t:0/0},r.profile.getTimers=function(){return i.extend({},this._profileTimes)}}(),function(e,t){e.action={};var i={},r=!1;e.action.define=function(e,t){if(e in i)throw new Error("[ns.action] Can't redefine '"+e+"'");i[e]=t},e.action.copy=function(e,t){if(t in i)throw new Error("[ns.action] Can't redefine '"+t+"'");if(!(e in i))throw new Error("[ns.action] '"+e+"' is not defined");i[t]=i[e]},e.action.run=function(t,r,n,o){var s=i[t];e.assert(s,"ns.action","%s is not defined",t);try{return s(t,r,n,o)}catch(a){e.log.exception("ns.action",a)}},e.action.getParams=function(e){var t=e.getAttribute("data-params");if(t&&"{"===t.charAt(0))try{return JSON.parse(t)}catch(i){}return{}},e.action.init=function(){if(!r){r=!0;var t=$("body"),i=".ns-action",n=[e.V.EVENTS.click,e.V.EVENTS.dblclick].join(" ");t.on(n,i,this._process)}},e.action._process=function(i){var r=i.currentTarget,n="dblclick"===i.type?r.getAttribute("data-dblclick-action"):r.getAttribute("data-click-action"),o=!0;return n&&(o=e.action.run(n,e.action.getParams(r),r,i)),o===t||Vow.isPromise(o)?!1:o},e.action._reset=function(){i={}}}(r),function(){r.Model=function(){},i.extend(r.Model.prototype,r.Events);var e={},t={},n={},o=0;r.Model.prototype.STATUS=r.M.STATUS,r.Model.prototype.RETRY_LIMIT=3,r.Model.prototype.status=r.M.STATUS.NONE,r.Model.prototype.key=null,r.Model.prototype.params=null,r.Model.prototype._errorFixingPromise=null,r.Model.prototype._init=function(e,t){this.id=e,this._reset(),this.info=r.Model.info(e),i.extend(this,r.Model.getKeyAndParams(e,t,this.info)),this._reinit()},r.Model.prototype._reinit=function(){this.status===this.STATUS.NONE&&(this._bindEvents(),this.status=this.STATUS.INITED,this.trigger("ns-model-init"))},r.Model.prototype._reset=function(e){this.data=null,this.error=null,this._softReset(e),this._version=0},r.Model.prototype._softReset=function(e){this.status=e||this.STATUS.NONE,this.retries=0},r.Model.prototype._bindEvents=function(){for(var e in this.info.events){var t=this.info.events[e];Array.isArray(t)||(t=[t]);for(var i=0,r=t.length;r>i;i++)this.on(e,this._prepareCallback(t[i]))}},r.Model.prototype._unbindEvents=function(){for(var e in this.info.events){var t=this.info.events[e];Array.isArray(t)||(t=[t]);for(var i=0,r=t.length;r>i;i++)this.off(e,this._prepareCallback(t[i]))}},r.Model.prototype._prepareCallback=function(e){return"string"==typeof e&&(e=this[e]),r.assert("function"==typeof e,"ns.Model","Can't find method '%s' in '%s' to bind event",e,this.id),e},r.Model.prototype.invalidate=function(){this._softReset(this.STATUS.INVALID)},r.Model.prototype.destroy=function(){this.trigger("ns-model-before-destroyed"),this._reset(this.STATUS.NONE),this.trigger("ns-model-destroyed"),this._unbindEvents()},r.Model.prototype.isValid=function(){return this.status===this.STATUS.OK},r.Model.prototype.getData=function(){return this.data},r.Model.prototype.get=function(e){var t=this.data;return t?i.jpath(e,t):void 0},r.Model.prototype.select=function(e){var t=this.data;return t?i.jpath.raw(e,t).toArray():[]},r.Model.prototype.set=function(e,t,r){var n=this.data;if(this.isValid()&&n&&(i.jpath.set(e,n,t),r=r||{},r.jpath=e,this.touch(r),!r.silent))for(var o=e.split("."),s=o.length;s>1;){var a=o.slice(0,s).join(".");this.trigger("ns-model-changed"+a,a,e),s--}},r.Model.prototype.setData=function(e,t){return this._reinit(),!e||this.isValid()&&!this.hasDataChanged(e)||(this.data=this._beforeSetData(this.preprocessData(e),t),this.status=this.STATUS.OK,this.error=null,this.touch(t)),this},r.Model.prototype.hasDataChanged=function(e){return!!e},r.Model.prototype.getError=function(){return this.error},r.Model.prototype.setError=function(e){this.isErrorCanBeFixed(e)?this._errorFixingPromise=this.fixError(e):(this.data=null,this.error=e,this.status=this.STATUS.ERROR)},r.Model.prototype.isErrorCanBeFixed=function(){return!1},r.Model.prototype.fixError=function(){return Vow.resolve()},r.Model.prototype._beforeSetData=function(e){return e},r.Model.prototype.preprocessData=function(e){return e},r.Model.prototype.getRequestParams=function(){return r.Model._getKeyParams(this.id,this.params,this.info)},r.Model.prototype.canRequest=function(){return(!this.retries||!this.isDo())&&this.retries<this.RETRY_LIMIT},r.Model.prototype.extractData=function(e){return e?e.data:void 0},r.Model.prototype.extractError=function(e){return e?e.error:void 0},r.Model.prototype.isDo=function(){return this.info.isDo},r.Model.prototype.getVersion=function(){return this._version},r.Model.prototype._incVersion=function(){this._version++},r.Model.prototype.touch=function(e){if(e=e||{},!e.silent){this._incVersion(),this.trigger("ns-model-touched");var t=e.jpath||"";this.trigger("ns-model-changed",t)}},r.Model.prototype.prepareRequest=function(e){return this.requestID=e,this.retries++,this.promise=new Vow.Promise,this},r.Model.prototype.finishRequest=function(){this._errorFixingPromise?this._errorFixingPromise.then(this.__finishRequest,this.__finishRequest,this):this.__finishRequest()},r.Model.prototype.__finishRequest=function(){this._errorFixingPromise&&(this._errorFixingPromise=null,this.retries=0),this.promise.fulfill()},r.Model.prototype.destroyWith=function(e){r.Model.destroyWith(this,e)},r.Model.get=function(t,i){var r=this._find(t,i);if(!r){var o=e[t];r=new o,r._init(t,i),r.isDo()||(n[t][r.key]=r)}return r._reinit(),r},r.Model.getValid=function(e,t){var i=this._find(e,t);return i&&i.isValid()?i:null},r.Model._find=function(e,i){r.assert(e in t,"ns.Model","'%s' is not defined",e);var o=r.Model.key(e,i);return n[e][o]||null},r.Model.destroy=function(e){if(!e.isDo()){var t=e.id,i=e.key,r=n[t][i];r&&e.destroy()}},r.Model.isValid=function(e,t){return!!r.Model.getValid(e,t)},r.Model.define=function(o,s,a){r.assert(!(o in t),"ns.Model","Can't redefine '%s'",o),s=s||{},"undefined"==typeof s.isCollection&&(s.isCollection=!!s.split);var l=a;"string"==typeof a?(l=e[a],r.assert(l,"ns.Model","Can't find '%s' to extend '%s'",a,o)):a||(l=s.uniq?r.ModelUniq:s.isCollection?r.ModelCollection:r.Model);var u=s.ctor||function(){};return u=i.inherit(u,l,s.methods),s.ready=!1,t[o]=s,e[o]=u,n[o]={},u},r.Model._reset=function(){n={},e={},t={}},r.Model._clear=function(){for(var e in t)n[e]={}},r.Model.info=function(e){var t=r.Model.infoLite(e);return t.ready||(t.params=t.params||{},t.events=t.events||{},t.isDo=/^do-/.test(e),t.ready=!0),t},r.Model.infoLite=function(e){var i=t[e];return r.assert(i,"ns.Model","'%s' is not defined",e),i},r.Model.key=function(e,t,i){return r.Model.getKeyAndParams(e,t,i).key},r.Model.getKeyAndParams=function(e,t,i){if(i=i||r.Model.info(e),i.isDo)return{key:"do-"+e+"-"+o++,params:t};var n="model="+e,s=r.Model._getKeyParams(e,t,i);return{key:r.key(n,s),params:s}},r.Model._getKeyParams=function(e,t,i){if(t=t||{},i=i||r.Model.info(e),"function"==typeof i.params)return i.params(t);for(var n=i.params,o=i.pNames||(i.pNames=Object.keys(i.params)),s={},a=0,l=o.length;l>a;a++){var u=o[a],p=t[u];p=void 0===p?n[u]:p,null!=p&&(s[u]=p)}return"function"==typeof i.paramsRewrite&&(s=i.paramsRewrite(s)),s},r.Model.invalidate=function(e,t){t=t||function(){return!0};var i=n[e];for(var r in i){var o=i[r];
t(o)&&o.invalidate()}},r.Model.destroyWith=function(e,t){Array.isArray(t)||(t=[t]);for(var i=0,n=t.length;n>i;i++){var o=t[i];r.assert(o instanceof r.Model,"ns.Model","destroyWith called for '%s' while one of the withModels is not instance of ns.Model",e.id),o.on("ns-model-destroyed",function(){r.Model.destroy(e)})}},r.Model.isCollection=function(e){return(e.info||r.Model.infoLite(e.id)).isCollection},r.Model.traverse=function(e,t){r.Model.infoLite(e),r.assert("function"==typeof t,"ns.Model.traverse","callback must be a function");var i=n[e];for(var o in i)t(i[o])},r.ModelUniq=function(){},i.inherit(r.ModelUniq,r.Model),r.ModelUniq.prototype.__superInit=r.ModelUniq.prototype._init,r.ModelUniq.prototype._init=function(e){var t=r.Model.info(e);t.events.changed=t.events.changed||[];var i=t.events.changed,n=function(){var e=this,t=this.params[this.uniqName];this.uniqCached||(this.uniqCached={}),t.forEach(function(t,i){e.uniqCached[i]=!0})};Array.isArray(i)?i.unshift(n):t.events.changed=[n,t.events.changed],this.__superInit.apply(this,arguments)},r.ModelUniq.prototype._superIsValid=r.Model.prototype.isValid,r.ModelUniq.prototype.isValid=function(){return-1===this.key.indexOf("&"+this.uniqName+"=")?!0:this._superIsValid()},r.ModelUniq.prototype.uniqName="",r.ModelUniq.prototype.uniqPath="",r.ModelUniq.prototype.uniqCached=null,r.ModelUniq.prototype.uniq=function(e,t){var r=this,n=this.uniqName,o=i.extend({},e);if(this.uniqCached||(this.uniqCached={}),t)for(var s in e)t[s]=s===n?[]:e[s];return o[n]=[].concat(o[n]).map(function(e){return r.uniqCached[e]?(t&&t[n].push(e),null):e}),o[n].length||delete o[n],t&&!t[n].length&&delete t[n],o},r.ModelUniq.prototype.uniqFromKey=function(e){return((e.split(this.uniqName+"=")[1]||"").split("&")[0]||"").split(",")},r.ModelUniq.prototype.uniqFromJSON=r.todo,r.ModelUniq.prototype.getData=function(e){var t=this,i=this.uniqPath,r=[].concat(e[this.uniqName]),o={};o[i]=[];var s=n[this.id];for(var a in s)for(var l=s[a],u=t.uniqFromKey(a),p=0,h=r.length;h>p;p++)if(u.indexOf(r[p])>-1){var d=t.uniqFromJSON(l.data,r[p]);d&&o[i].push(d),r.splice(p,1),p--}return o}}(),function(){r.ModelCollection=function(){},i.inherit(r.ModelCollection,r.Model),r.ModelCollection.prototype.DEFAULT_ITEMS_SPLIT=".items",r.ModelCollection.prototype._init=function(){this._modelsEvents={},this.models=[],r.Model.prototype._init.apply(this,arguments)},r.ModelCollection.prototype.getData=function(){if(this.isValid()){var e;e=this.info.split?this.info.split.items:this.info.jpathItems?this.info.jpathItems:this.DEFAULT_ITEMS_SPLIT,this.data||(this.data={}),"/"===e?this.data=[]:i.jpath.set(e,this.data,[]);var t=i.jpath(e,this.data);this.models.forEach(function(e){t.push(e.getData())})}return this.data},r.ModelCollection.prototype._reset=function(){r.Model.prototype._reset.apply(this,arguments),this.clear()},r.ModelCollection.prototype._beforeSetData=function(e,t){var r=this.info.split;if(r){var n=i.jpath(r.items||this.DEFAULT_ITEMS_SPLIT,e),o=this._splitModels(n,t),s=this.__filterExistsModels(this.models,o),a=this.__filterExistsModels(o,this.models);this.__removeModels(a),this.__insertModels(s,0),this.models=o}else this.clear();return e},r.ModelCollection.prototype._splitModels=function(e,t){for(var n=this.info.split,o=[],s=0,a=e.length;a>s;s++){var l=e[s],u={};for(var p in n.params)u[p]=i.jpath(n.params[p],l);var h;h="function"==typeof n.model_id?n.model_id(l,u):n.model_id,h&&o.push(r.Model.get(h,u).setData(l,t))}return o},r.ModelCollection.prototype._subscribeSplit=function(e){var t=this;this.bindModel(e,"ns-model-changed",function(i,r){t.onItemChanged(i,e,r)}),this.bindModel(e,"ns-model-touched",function(i){t.onItemTouched(i,e)}),this.bindModel(e,"ns-model-before-destroyed",function(i){t.onItemDestroyed(i,e)})},r.ModelCollection.prototype.__filterExistsModels=function(e,t){for(var i=this.__buildModelsHash(e),r=[],n=0,o=t.length;o>n;n++){var s=t[n];i.hasOwnProperty(s.key)||r.push(s)}return r},r.ModelCollection.prototype.__buildModelsHash=function(e){for(var t={},i=0,r=e.length;r>i;i++)t[e[i].key]=0;return t},r.ModelCollection.prototype.bindModel=function(e,t,i){var r=this._modelsEvents[e.key]||(this._modelsEvents[e.key]={});e.on(t,i),r[t]=i},r.ModelCollection.prototype.unbindModel=function(e,t){var i=this._modelsEvents[e.key];i&&i[t]&&(e.off(t,i[t]),delete i[t])},r.ModelCollection.prototype.onItemChanged=function(e,t,i){this.trigger("ns-model-changed",{model:t,jpath:i})},r.ModelCollection.prototype.onItemTouched=function(){this._version++},r.ModelCollection.prototype.onItemDestroyed=function(e,t){this.remove(t)},r.ModelCollection.prototype.getSelfVersion=function(){return this._versionSelf},r.ModelCollection.prototype._incVersion=function(){r.Model.prototype._incVersion.apply(this,arguments),this._versionSelf=this._version},r.ModelCollection.prototype._unsubscribeSplit=function(e){if(e.key in this._modelsEvents){var t=this._modelsEvents[e.key];for(var i in t)e.off(i,t[i]);delete this._modelsEvents[e.key]}},r.ModelCollection.prototype.clear=function(){var e=this.models;if(this.models=[],e&&e.length){var t=this;e.forEach(function(e){t._unsubscribeSplit(e)}),this.trigger("ns-model-remove",e)}},r.ModelCollection.prototype.insert=function(e,t){this._reinit(),isNaN(t)&&(t=this.models.length),Array.isArray(e)||(e=[e]);for(var i=[],r=this.__buildModelsHash(e),n=0,o=e.length;o>n;n++){var s=e[n];0===r[s.key]&&(i.push(s),r[s.key]++)}var a=this.__filterExistsModels(this.models,i);return this.__insertModels(a,t)},r.ModelCollection.prototype.__insertModels=function(e,t){for(var i=0,r=e.length;r>i;i++)this.models.splice(t+i,0,e[i]),this._subscribeSplit(e[i]);return e.length>0?(this.status=this.STATUS.OK,this.trigger("ns-model-insert",e),!0):!1},r.ModelCollection.prototype.remove=function(e){Array.isArray(e)||(e=[e]);for(var t=this._modelsIndexToInstance(e),i=[],r=0,n=t.length;n>r;r++){var o=t[r],s=this.models.indexOf(o);s>-1&&(o._itemToRemoveIndex=s,i.push(o))}return this.__removeModels(i)},r.ModelCollection.prototype.__removeModels=function(e){e=e.sort(function(e,t){return t._itemToRemoveIndex-e._itemToRemoveIndex});for(var t=0,i=e.length;i>t;t++)this._unsubscribeSplit(e[t]),this.models.splice(e[t]._itemToRemoveIndex,1);return e.length?(this.trigger("ns-model-remove",e),!0):!1},r.ModelCollection.prototype._modelsIndexToInstance=function(e){for(var t=[],i=0,r=e.length;r>i;i++){var n=e[i];if("number"==typeof n){var o=this.models[n];this.models[n]&&t.push(o)}else t.push(n)}return t}}(),function(){function e(t,r){var s={};if("string"==typeof t)s[t]=!0,t=s;else if(Array.isArray(t)){for(var a=0,l=t.length;l>a;a++)s[t[a]]=!0;t=s}var u={};for(var p in t){var h=p;p.indexOf("{")>-1&&(h=i.jpath.string(p)(r));var d,c=t[p];switch(typeof c){case"function":d=e(c(r),r);break;case"object":case"string":d=e(c,r);break;default:d={}}u[o(h)]={type:n(h),views:d}}return u}function t(e,t){var i=r.object.clone(t);for(var s in e){var l=s.split(a),u=l.length;if(n(l[u-1])!==r.L.BOX)throw new Error("[ns.layout] Can't overwrite view layout '"+l[u-1]+"'");for(var p=i,h=0;u-1>h;h++)if(p=p[o(l[h])].views,!p)throw new Error('[no.layout] Path "'+l.slice(0,h).join(" ")+'" is undefined in this layout and cannot be extended');p[o(l[u-1])]=e[s]}return i}function n(e){var t=e.substr(-1);return"@"===t?r.L.BOX:"&"===t?r.L.ASYNC:r.L.VIEW}function o(e){if(a.test(e))return e;var t=e.slice(-1);return("@"===t||"&"===t)&&(e=e.slice(0,-1)),e}r.layout={};var s={},a=/\s+/;r.layout.define=function(e,t,i){if(s[e])throw new Error("[ns.layout] Can't redefine '"+e+"'");s[e]={layout:t,parent_id:i}},r.layout.undefine=function(e){delete s[e]},r.layout._reset=function(){s={}},r.layout.page=function(i,n){var o=s[i];if(!o)throw new Error("[ns.layout] '"+i+"' is not defined");var a=e(o.layout,n);if(o.parent_id){var l=r.layout.page(o.parent_id,n);a=t(a,l)}return a},r.layout.generateSimple=function(e,t){t=t||"ns-auto-layout-";var i=t+e;if(i in s)return i;var n={};return n[e]={},r.layout.define(i,n),i}}(),function(e){e.log={},e.log.debug=function(){console.log.apply(console,arguments)},e.log.info=function(){},e.log.error=function(){},e.log.exception=function(){}}(r),function(){function i(e){return r.events.trigger("ns-page-after-load",e),e}function n(e){return r.events.trigger("ns-page-error-load",e),Vow.reject(e)}r.page={},r.page.current={},r.page.currentUrl=null,r.page.DEFAULT_HISTORY_ACTION="push",r.page.go=function(t,i){if(i?i===!0&&(i="replace"):i=r.page.DEFAULT_HISTORY_ACTION,t=t||r.page.getCurrentUrl(),!r.page.block.check(t))return t!==r.page.currentUrl&&r.history.replaceState(r.page.currentUrl),Vow.reject("block");var o=r.router(t);return o.page===r.R.REDIRECT?r.page.redirect(o.redirect):o.page===r.R.NOT_APP_URL?("replace"===i?e.location.replace(o.redirect):e.location=o.redirect,new Vow.Promise):(r.events.trigger("ns-page-before-load",[r.page.current,o],t),"push"===i&&t===r.page.currentUrl&&(i="preserve"),r.page.followRoute(o).then(function(){return r.page._setCurrent(o,t),r.page._fillHistory(t,i),r.page.title(),r.page.startUpdate(o)},n))},r.page.followRoute=function(){return Vow.fulfill()},r.page.startUpdate=function(e){var t=r.layout.page(e.page,e.params),o=new r.Update(r.MAIN_VIEW,t,e.params);return o.start().then(i,n)},r.page._setCurrent=function(e,t){r.page.current=e,r.page.currentUrl=t},r.page._fillHistory=function(e,t){"push"===t?(r.history.pushState(e),r.page.history.push(e)):"replace"===t&&(r.history.replaceState(e),r.page.history.replace(e))},r.page.redirect=function(e){return r.history.replaceState(e),r.page.go(e,!0)},r.page.title=function(){t.title="NoScript app "+r.page.currentUrl.url},r.page._reset=function(){this.current={},this.currentUrl=""},r.page.getDefaultUrl=function(){return r.router.url("/")},r.page.getCurrentUrl=function(){return e.location.pathname+e.location.search}}(),function(){r.page.block={},r.page.block._checkers=[],r.page.block.add=function(e){return r.page.block._checkers.push(e),this},r.page.block.remove=function(e){var t=r.page.block._checkers,i=t.indexOf(e);return i>-1&&t.splice(i,1),this},r.page.block.clear=function(){return r.page.block._checkers=[],this},r.page.block.check=function(e){for(var t=r.page.block._checkers,i=0,n=t.length;n>i;i++)if(t[i](e)===!1)return!1;return!0}}(),function(){r.page.history={},r.page.history._current=null,r.page.history._history=[],r.page.history.push=function(e){var t=r.page.history;if(t._current&&t._current!==e){var i=r.page.history.getPrevious();i===e?t._history.pop():t._history.push(t._current)}t._current=e},r.page.history.replace=function(e){var t=r.page.history;t._history.pop(),t._history.push(e),t._current=e},r.page.history.back=function(){var e=r.page.history,t=e.getPrevious();return t?e._history.pop():t=r.page.getDefaultUrl(),e._current=t,r.page.go(t)},r.page.history.getPrevious=function(e){e=e||0;var t=r.page.history._history,i=t.length;return t[i-e-1]},r.page.history.reset=function(){r.page.history._current=null,r.page.history._history=[]}}(),function(){function e(e){for(var t={},i=0,r=e.length;r>i;i++){var n="."+i,o=e[i];t["_model"+n]=o.id;var s=o.getRequestParams();for(var a in s)t[a+n]=s[a]}return t}function t(e,t){for(var i=[],r=0,n=e.length;n>r;r++)i.push({id:e[r],params:t});return i}function n(e){return e.promise}function o(e,i){"string"==typeof e&&(e=[e]),"string"==typeof e[0]&&(i=i||{},e=t(e,i));for(var n=[],o=0,s=e.length;s>o;o++){var a=e[o];a instanceof r.Model?n.push(a):a.model&&a.model instanceof r.Model?n.push(a.model):n.push(r.Model.get(a.id,a.params))}return n}function s(e){return e.id}r.request=function(e,t,i){return r.request.models(o(e,t),i)},r.forcedRequest=function(e,t,i){return i=i||{},i.forced=!0,r.request.models(o(e,t),i)},r.request.models=function(e,t){e=e.map(function(e){return e.getRequest?e.getRequest():e});var i=new l(e,t);return i.start()},r.request.requestParams={},r.request.addRequestParams=function(e){i.extend(e,r.request.requestParams)},r.request.URL="/models/",r.request.canProcessResponse=function(){return!0},r.request._reset=function(){r.request.manager._keys={}},r.request.extractModel=function(e,t){var i,r;t?(i=e.extractData(t),i||(r=e.extractError(t),r||(r={id:"INVALID_FORMAT",reason:"response should contain result or error"}))):r={id:"NO_DATA",reason:"Server returned no data"},i?e.setData(i):e.setError(r)};var a=0,l=function(e,t){this.id=a++,this.models=e,this.options=t||{},this.promise=new Vow.Promise};l.prototype.start=function(){for(var e=[],t=[],i=this.models,n=0,o=i.length;o>n;n++){var s=i[n],a=r.request.manager.add(s,this.id,this.options.forced);a===!0?t.push(s):a instanceof r.Model&&e.push(s)}return this.request(e,t),this.promise},l.prototype.request=function(t,i){var o,a=[];if(i.length){var l=[],u=[];if(i.forEach(function(e){if("function"==typeof e.request){var t=e.request().then(function(){r.request.manager.done(e)},function(){r.request.manager.done(e)});e.promise=t,u.push(t)}else l.push(e)}),a=a.concat(u),l.length){var p=e(l),h=l.map(s);r.request.addRequestParams(p),o=r.http(r.request.URL+"?_m="+h.join(","),p),a=a.concat(l.map(n))}}if(t.length&&(a=a.concat(t.map(n))),a.length){var d=this;o&&o.then(function(e){r.request.canProcessResponse(e)===!1?(r.request.manager.clean(d.models),d.promise.reject({error:"CANT_PROCESS",invalid:d.models,valid:[]})):d.extract(l,e)},function(e){r.log.error("ns.request.http",e),d.extract(l,{})}),Vow.all(a).then(this.start.bind(this))}else{r.request.manager.clean(this.models);for(var c=[],f=[],v=0,y=this.models.length;y>v;v++){var _=this.models[v];_.isValid()?c.push(_):f.push(_)}f.length?this.promise.reject({invalid:f,valid:c}):this.promise.fulfill(this.models)}},l.prototype.extract=function(e,t){for(var i=t&&t.models||[],n=0,o=e.length;o>n;n++){var s=e[n],a=i[n];s.requestID>this.id||(r.request.extractModel(s,a),r.request.manager.done(s),s.finishRequest())}}}(),r.request.manager={STATUS:{LOADING:0,FAILED:1,DONE:2},_keys:{},add:function(e,t,i){var r=this.STATUS,n=e.key,o=this._keys[n];return o?e.isValid()&&!i?!1:o.status===r.LOADING?e.isDo()?o.model:i?(o.model.requestID=t,!0):o.model:o.status===r.FAILED?o.model.canRequest()?(this._createRequest(e,t),!0):(e.status=e.STATUS.ERROR,this.done(e,!0),!1):e.isValid()?!1:e.canRequest()?(this._createRequest(e,t),!0):!1:e.isValid()?i&&e.requestID!==t?(this._createRequest(e,t),!0):!1:e.canRequest()?(this._createRequest(e,t),!0):!1},done:function(e,t){var i=this._keys[e.key];i&&(i.status=e.isValid()||t?this.STATUS.DONE:this.STATUS.FAILED)},clean:function(e){for(var t=0,i=e.length;i>t;t++){var r=e[t];r.retries=0,delete this._keys[r.key]}},_createRequest:function(e,t){this._keys[e.key]={status:this.STATUS.LOADING,model:e},e.prepareRequest(t)}},r.router=function(e){var t=r.router.baseDir,i=r.router._routes;if(0!==e.indexOf(t))return{page:r.R.NOT_APP_URL,params:{},redirect:e};e=e.substring(t.length),e||(e="/");var n=r.router._processRedirect(i.redirect,e);if(n)return{page:r.R.REDIRECT,params:{},redirect:t+n};var o=e.split("?"),s=o.shift();if(s in i.rewriteUrl){var a=o.join("?");e=i.rewriteUrl[s]+(a?"?"+a:"")}for(var l=i.route,u=0,p=l.length;p>u;u++){var h=l[u],d=r.router._parseUrl(h,e);if(d)return h.page in i.rewriteParams&&(d=i.rewriteParams[h.page](d)),{page:h.page,params:d}}return{page:r.R.NOT_FOUND,params:{}}},r.router.URL_FIRST_SYMBOL="/",r.router._getParamsRouteFromUrl=function(e,t){for(var i,r=e.params,n={},o=r.length,s=0;o>s;s++){i=r[s];var a=t[s+1];if(a)try{a=decodeURIComponent(a)}catch(l){a=""}a||(a=i.default_value),n[i.name]=a}return n},r.router._parseUrl=function(e,t){var n=e.regexp.exec(t);if(n){var o=r.router._getParamsRouteFromUrl(e,n),s=n[e.params.length+1];return s&&i.extend(o,r.parseQuery(s)),o}return null},r.router._processRedirect=function(e,t){for(var i,n=0,o=e.length;o>n;n++){var s=e[n];if("function"==typeof s.path){var a=r.router._parseUrl(s,t);a&&(i=s.path(a,t))}else s.regexp.test(t)&&(i=s.path);if(i)return i}return null},r.router.init=function(){var e=r.router.routes;r.router._regexps={};for(var t in r.router.regexps)r.router._regexps[t]=new RegExp("^"+r.router.regexps[t]+"$");var i={};i.redirect=e.redirect||{},i.rewriteUrl=e.rewriteUrl||{},i.rewriteParams=e.rewriteParams||{};var n=e.route||{},o=[],s={};for(var a in n){var l=n[a],u=r.router.compile(a);u.page=l,o.push(u),s[l]=s[l]||[],s[l].push(u)}i.route=o,i.routeHash=s;var p=e.redirect||{},h=[];for(var d in p){var u=r.router.compile(d);h.push({regexp:u.regexp,path:p[d],params:u.params})}i.redirect=h,r.router._routes=i},r.router.url=function(e){return r.router.baseDir+e||"/"},r.router.generateUrl=function(e,t){var i,n=r.router._routes.routeHash[e];t=t||{},r.assert(n&&n.length,"ns.router","Could not find route with id '%s'!",e);for(var o=0;o<n.length&&(i=r.router._generateUrl(n[o],t),null===i);o++);return r.assert(null!==i,"ns.router","Could not generate url for layout id '%s'!",e),r.router.url(i)},r.router._generateUrl=function(e,t){for(var n,o,s,a,l,u=[],p=i.extend({},t),h=r.router._routes.rewriteUrl,d=0;d<e.sections.length;d++){o=e.sections[d],s="";for(var c=0;c<o.items.length;c++)if(l=o.items[c],l.name){a=t[l.name];var f=l.name in t;if(l.is_optional&&!f&&(a=l.default_value),l.is_filter&&a!==l.filter_value)return null;if(!l.is_optional&&!f)return null;if(l.is_optional&&!f)continue;if(!r.router._isParamValid(a,l.type))return null;s+=encodeURIComponent(a),delete p[l.name]}else s+=l.default_value;(s||!o.is_optional)&&u.push(s)}n=u.join("/"),n=n?r.router.URL_FIRST_SYMBOL+n:"";for(var v=!0;v;){v=!1;for(var y in h){var _=h[y],m=_.length,g=n.substr(0,m);if(g===_){var w=n.charAt(m);"/"!==w&&"?"!==w&&w||(n=y+n.substr(_.length),v=!0)}}}var V=r.params2query(p);return V?n+"?"+V:n},r.router.compile=function(e){e=e.replace(/\/$/,""),e[0]===r.router.URL_FIRST_SYMBOL&&(e=e.substr(1));var t=e.split("/"),i=t.map(r.router._parseSection),n=i.map(r.router._generateSectionRegexp);"/"===n[0][0]&&(n[0]=r.router.URL_FIRST_SYMBOL+n[0].substr(1));var o=n.join(""),s=[];return i.forEach(function(e){s=s.concat(e.items.filter(function(e){return!!e.name}))}),o="^"+o+"/?(?:\\?(.*))?$",{regexp:new RegExp(o),params:s,sections:i}},r.router._parseSection=function(e){for(var t=0,i=-1,n=-1,o=[];;){if(i=e.indexOf("{",t),0>i)break;n=e.indexOf("}",i),r.assert(n>0,"ns.router","could not parse parameter in url section: %s",e),i>t&&o.push({default_value:e.substr(t,i-t)}),o.push(r.router._parseParam(e.substr(i+1,n-i-1))),t=n+1}return t<e.length&&o.push({default_value:e.substr(t)}),{is_optional:o.length&&o.filter(function(e){return e.is_optional}).length===o.length,items:o}},r.router._parseParam=function(e){var t,i,n,o,s,a,l=!1;t=e.split("=");var u=t[0].split(":");return a=u[0],i=u[1]||"id",3===t.length?(o=!1,l=!0,s=t[2],r.assert(s,"ns.router","Parameter '%s' value must be specified",a),r.assert(r.router._isParamValid(s,i),"ns.router","Wrong value for '%s' parameter",a)):(o=2===t.length,n=t[1]),{name:a,type:i,default_value:n,is_optional:o,is_filter:l,filter_value:s}},r.router._generateSectionRegexp=function(e){var t="";return e.items.forEach(function(e){t+=r.router._generateParamRegexp(e)}),t=e.is_optional?"(?:/(?!/)"+t+")?":"/"+t},r.router._generateParamRegexp=function(e){var t,i=r.router.regexps;return e.default_value&&!e.name?e.default_value:(e.type&&r.assert(e.type in i,"ns.router","Could not find regexp for type '%s'!",e.type),e.is_filter&&e.filter_value?t="("+e.filter_value+")":(t=i[e.type],t="("+t+")",e.is_optional&&(t="(?:"+t+")?")),t)},r.router._isParamValid=function(e,t){var i=r.router._regexps[t];return r.assert(i,"ns.router","Could not find regexp for type '%s'!",t),i.test(e)},r.router._reset=function(){this.baseDir="",this._routes=null,this.routes={},this.regexps={id:"[A-Za-z_][A-Za-z0-9_-]*","int":"[0-9]+"}},r.router._reset(),function(){function e(e){for(var t={},i=[],r=0,n=e.length;n>r;r++){var o=e[r].models;for(var s in o){var a=o[s],l=a.key;t[l]||(i.push(a),t[l]=!0)}}return i}r.Update=function(e,t,i,o){if(this.view=e,!(this.view.id in t))throw new Error("[ns.Update] Can't find view layout");this.layout=t[this.view.id],this.params=i,this.id=++n,this.promise=new Vow.Promise,o=o||{},this.EXEC_FLAG=o.execFlag||r.U.EXEC.GLOBAL,this.log("created instance",this,"with layout",this.layout,"and params",this.params),this.startTimer("full"),o.timers&&(this._profileTimes.__parent=o.timers),r.Update._addToQueue(this)||this.abort()},i.extend(r.Update.prototype,r.profile);var t=[],n=-1;r.Update.prototype.STATUS=r.U.STATUS,r.Update.prototype._EVENTS_ORDER=["ns-view-hide","ns-view-htmldestroy","ns-view-htmlinit","ns-view-async","ns-view-show","ns-view-touch"],r.Update.prototype._requestCount=0,r.Update.prototype.log=function(){if(r.DEBUG){var e=Array.prototype.slice.apply(arguments);"generated html"===e[0]&&(e[1]=r.html2node(e[1])),r.log.debug.apply(r.log,["[ns.Update]",this.id].concat(e))}},r.Update.prototype._requestModels=function(e){var t="requestModels."+this._requestCount;this.startTimer(t),this.log("started models request",e);for(var i=!0,n=0,o=e.length;o>n;n++)if(!e[n].isValid()){i=!1;break}if(i)return this.stopTimer(t),this.log("received models",e),Vow.fulfill(e);var s=r.request.models(e);return s.always(function(){this.stopTimer(t)},this),s.then(this._onRequestModelsOK,this._onRequestModelsError,this)},r.Update.prototype._onRequestModelsOK=function(e){return this.log("received models",e),e},r.Update.prototype._onRequestModelsError=function(e){this.log("failed to receive models",e);var t={error:this.STATUS.MODELS,invalidModels:e.invalid,validModels:e.valid};return r.Update.handleError(t,this)?[].concat(e.invalid,e.valid):Vow.reject(t)},r.Update.prototype._getActiveViews=function(){var e="collectModels."+this._requestCount;this.startTimer(e);var t=this.view._getRequestViews({sync:[],async:[],hasPatchLayout:!1},this.layout,this.params);return this.stopTimer(e),this.log("collected incomplete views",t),t},r.Update.prototype._requestSyncModels=function(){var t=this._getActiveViews(),i=e(t.sync);return this.log("collected needed models",i),this._requestModels(i).then(function(){return t.hasPatchLayout?(this._requestCount++,this._requestSyncModels()):void 0},null,this)},r.Update.prototype._requestAllModels=function(){if(this._expired())return this._rejectWithStatus(this.STATUS.EXPIRED);var t=new Vow.Promise,i=this._getActiveViews(),r=e(i.sync);this.log("collected needed models",r);var n=this._requestModels(r),o=i.async.map(function(e){return e.updateAfter(this.promise,this.params,this)},this);return n.then(function(){i.hasPatchLayout?(this._requestCount++,t.sync(this._requestAllModels())):t.fulfill({async:o})},function(e){t.reject(e)},this),t},r.Update.prototype._applyLayout=function(){this._getActiveViews()},r.Update.prototype._generateHTML=function(){return this._expired()?this._rejectWithStatus(this.STATUS.EXPIRED):Vow.fulfill(this._renderUpdateTree())},r.Update.prototype._renderUpdateTree=function(){this.startTimer("collectViews");var e={views:{}};this.view._getUpdateTree(e),this.log("created render tree",e),this.stopTimer("collectViews");var t;return r.object.isEmpty(e.views)||(this.startTimer("generateHTML"),t=this.applyTemplate(e,this.params,this.layout),this.log("generated html",t),this.stopTimer("generateHTML")),t},r.Update.prototype._insertNodes=function(e){if(this._expired())return this._rejectWithStatus(this.STATUS.EXPIRED);this.startTimer("triggerHideEvents");var t={"ns-view-hide":[],"ns-view-htmldestroy":[]};this.view.beforeUpdateHTML(t,!1),this._triggerViewEvents(t);var i={"ns-view-async":[],"ns-view-htmlinit":[],"ns-view-show":[],"ns-view-touch":[]};return this.switchTimer("triggerHideEvents","insertNodes"),this.view._updateHTML(e,{toplevel:!0},i),this.switchTimer("insertNodes","triggerEvents"),this._triggerViewEvents(i),this.stopTimer("triggerEvents"),Vow.fulfill()},r.Update.prototype._triggerViewEvents=function(e){for(var t=this.getTimers(),i=0,r=this._EVENTS_ORDER.length;r>i;i++)for(var n=this._EVENTS_ORDER[i],o=e[n]||[],s=o.length-1;s>=0;s--)o[s].trigger(n,this.params,t)},r.Update.prototype._updateDOM=function(){if(this._expired())return this._rejectWithStatus(this.STATUS.EXPIRED);var e=this._renderUpdateTree();this.startTimer("html2node");var t=r.html2node(e||"");this.stopTimer("html2node"),this._insertNodes(t)},r.Update.prototype.prefetch=function(){return this.log("started `prefetch` scenario"),this._requestSyncModels().then(this._fulfill,this._reject,this),this.promise},r.Update.prototype.generateHTML=function(){return this.log("started `generateHTML` scenario"),Vow.invoke(this._requestSyncModels.bind(this)).then(this._generateHTML,null,this).then(this._fulfill,this._reject,this),this.promise},r.Update.prototype.prerender=function(){return this.log("started `prerender` scenario"),r.todo(),this.promise},r.Update.prototype.render=function(){return this._expired()?(this._reject({error:this.STATUS.EXPIRED}),this.promise):(this.log("started `render` scenario"),Vow.invoke(this._requestAllModels.bind(this)).then(function(e){this._updateDOM(),this._fulfill(e)},this._reject,this).then(null,this._reject,this),this.promise)},r.Update.prototype.start=r.Update.prototype.render,r.Update.prototype.reconstruct=function(e){return this.log("started `reconstruct` scenario"),this._applyLayout(),Vow.invoke(this._insertNodes.bind(this),e).then(function(){this._fulfill({async:[]})},this._reject,this),this.promise},r.Update.prototype.applyTemplate=function(e){return r.renderString(e,null,"")},r.Update.prototype._expired=function(){return this.promise.isResolved()||-1===t.indexOf(this)},r.Update.prototype.abort=function(){this._reject({error:r.U.STATUS.EXPIRED})},r.Update.prototype._fulfill=function(e){this.promise.isResolved()||(r.Update._removeFromQueue(this),this.stopTimer("full"),this.promise.fulfill(e),this.perf(this.getTimers()),this.log("successfully finished scenario"))},r.Update.prototype._reject=function(e){this.promise.isResolved()||(r.Update._removeFromQueue(this),this.stopTimer("full"),this.promise.reject(e),this.log("scenario was rejected with reason",e))},r.Update.prototype._rejectWithStatus=function(e){return Vow.reject({error:e})},r.Update.prototype.isGlobal=function(){return this.EXEC_FLAG===r.U.EXEC.GLOBAL},r.Update.prototype.perf=function(){},r.Update.handleError=function(){return!1},r.Update._removeFromQueue=function(e){var i=t.indexOf(e);i>-1&&t.splice(i,1)},r.Update._addToQueue=function(e){var i,n,o=t,s=r.U.EXEC,a=s.GLOBAL,l=s.PARALLEL,u=s.ASYNC,p=e.EXEC_FLAG;if(p===a){var h=[];for(i=o.length-1;i>=0;i--){var d=o[i];d.EXEC_FLAG===l?h.push(d):d.abort()}t=h}else if(p===u)for(i=0,n=o.length;n>i;i++)if(o[i].EXEC_FLAG===a)return!1;return t.push(e),!0}}(),function(){var n=0,o=/ns-view-id-\d+/;r.View=function(){},i.extend(r.View.prototype,r.Events),r.View.prototype.STATUS=r.V.STATUS,r.View.prototype._$document="undefined"==typeof t?null:$(t),r.View.prototype._$window="undefined"==typeof e?null:$(e),r.View.prototype.key=null,r.View.prototype.params=null,r.View.prototype.node=null,r.View.prototype.$node=null,r.View.prototype.views=null,r.View.prototype.id=null,r.View.prototype._visible=!1,r.View.prototype.__uniqueId=null,r.View.prototype.__modelsEventsBinded=!1,r.View.prototype._init=function(e,t,n){this.id=e,this.__setUniqueId(),this.async=n,this.info=r.View.info(e),i.extend(this,r.View.getKeyAndParams(this.id,t||{},this.info)),this._initModels(),this._modelsVersions={},this.views={},this.status=this.STATUS.NONE,this.__customInit(),this._bindCreateEvents(),this.trigger("ns-view-init")},r.View.prototype.__setUniqueId=function(){this.__uniqueId||(this.__uniqueId="ns-view-id-"+ ++n)},r.View.prototype.__customInit=i.nop,r.View.prototype._initModels=function(){this.models={},this._modelsHandlers={};for(var e in this.info.models)if(!this.models[e]){var t=r.Model.get(e,this.params);this.models[e]=t,this._modelsHandlers[t.key]={}}},r.View.prototype._getView=function(e){return this.views[e]},r.View.prototype._addView=function(e,t,i){var n=this._getView(e);return n||(n=i===r.L.BOX?new r.Box(e,t):r.View.create(e,t,i===r.L.ASYNC),this.views[n.id]=n),n},r.View.prototype.__onHtmldestroy=function(){this._unbindEvents("init")},r.View.prototype._htmlinit=function(e){this._bindEvents("init"),e.push(this)},r.View.prototype.hideAndUnbindEvents=function(){this.__onHide()},r.View.prototype.__onHide=function(){var e=!this.isLoading()&&this._visible===!0;e&&this._unbindEvents("show"),this._visible=!1},r.View.prototype._show=function(e){return this.isLoading()||this._visible?!1:(this.__modelsEventsBinded||this.__bindModelsEvents(),this._bindEvents("show"),this._visible=!0,e&&e.push(this),!0)},r.View.prototype.__bindModelsEvents=function(){this.__modelsEventsBinded=!0;var e=this.models;for(var t in e){var i=e[t];this.__bindModelEvents(i)}},r.View.prototype.__bindModelEvents=function(e){var t=this.info.models[e.id];for(var n in t){var o=t[n],s=this[o]||t[n];r.View.assert("function"==typeof s,4,[this.id,o,e.id]),s===this.keepValid&&(s=i.nop),this.__bindModelEvent(e,n,this._invokeModelHandler.bind(this,s,e))}},r.View.prototype._invokeModelHandler=function(e,t){return this._saveModelVersion(t.id),e.apply(this,Array.prototype.slice.call(arguments,2))},r.View.prototype.__bindModelEvent=function(e,t,i){e.on(t,i),this._modelsHandlers[e.key][t]=i},r.View.prototype.__unbindModelsEvents=function(){var e=this.models;for(var t in e){var i=e[t];this.__unbindModelEvent(i)}},r.View.prototype.__unbindModelEvent=function(e){var t=this._modelsHandlers[e.key];for(var i in t)e.off(i,t[i]),delete t[i]},r.View.prototype._prepareCallback=function(e){if("string"==typeof e){var t=this[e];return r.View.assert(!!t,5,[e,this.id]),t}return e},r.View.prototype._bindEventHandlers=function(e,t){for(var i=[],r=0,n=e.length;n>r;r++){var o=e[r],s=[].concat(o);s[t]=this._prepareCallback(o[t]).bind(this),i.push(s)}return i},r.View.prototype._getEvents=function(e){var t="_"+e+"Events";if(!this[t]){var i=this.info[e+"Events"],r=this.info[e+"Nsevents"];this[t]={bind:this._bindEventHandlers(i.bind,2),delegate:this._bindEventHandlers(i.delegate,2),nsevents:this._bindEventHandlers(r,1)}}return this[t]},r.View.prototype._bindEvents=function(e){var t,i,n,o=this.$node,s=this._getEvents(e),a=s.delegate;for(t=0,i=a.length;i>t;t++)n=a[t],"window"===n[1]||"document"===n[1]?this["_$"+n[1]].on(n[0],n[2]):n[1]?o.on(n[0],n[1],n[2]):o.on(n[0],n[2]);var l=s.bind;for(t=0,i=l.length;i>t;t++)n=l[t],o.find(n[1]).on(n[0],n[2]);var u=s.nsevents;for(t=0,i=u.length;i>t;t++)n=u[t],r.events.on(n[0],n[1])},r.View.prototype._bindCreateEvents=function(){for(var e=0,t=this.info.createEvents.length;t>e;e++){var i=this.info.createEvents[e];this.on(i[0],this._prepareCallback(i[1]))}},r.View.prototype._unbindEvents=function(e){var t,i,n,o=this.$node,s=this._getEvents(e),a=s.delegate;for(t=0,i=a.length;i>t;t++)n=a[t],"window"===n[1]||"document"===n[1]?this["_$"+n[1]].off(n[0],n[2]):n[1]?o.off(n[0],n[1],n[2]):o.off(n[0],n[2]);var l=s.bind;for(t=0,i=l.length;i>t;t++)n=l[t],o.find(n[1]).off(n[0],n[2]);var u=s.nsevents;for(t=0,i=u.length;i>t;t++)n=u[t],r.events.off(n[0],n[1])},r.View.prototype.invalidate=function(){for(var e=this._getDescendantsAndSelf(),t=0,i=e.length;i>t;t++){var r=e[t];r.status===this.STATUS.OK&&(r.status=this.STATUS.INVALID)}},r.View.prototype.isOk=function(){return this.status===this.STATUS.OK},r.View.prototype.isLoading=function(){return this.status===this.STATUS.LOADING},r.View.prototype.isNone=function(){return this.status===this.STATUS.NONE},r.View.prototype.isValid=function(){return this.isOk()&&this.isModelsValidWithVersions()},r.View.prototype.isValidSelf=r.View.prototype.isValid,r.View.prototype.isValidWithDesc=function(){if(!this.isValid())return!1;for(var e in this.views)if(!this.views[e].isValidWithDesc())return!1;return!0},r.View.prototype.isModelsValidWithVersions=function(){return this.isModelsValid(this._modelsVersions)},r.View.prototype.isModelsValid=function(e){var t=this.models;for(var i in t){var r=t[i];if(!r.isValid()||e&&this._getModelVersion(i)>e[i])return!1}return!0},r.View.prototype.isVisible=function(){return this._visible},r.View.prototype._apply=function(e){var t=this.views;for(var i in t)e(t[i],i)
},r.View.prototype._saveLayout=function(e){this.layout={},this.layout[this.id]={views:e}},r.View.prototype._getRequestViews=function(e,t,i){var r=this.__evaluateState();this.__registerInUpdate(r,e);var n=!1;r&&(n=!0,"function"==typeof this.patchLayout&&(this.isModelsValid()?this.__patchLayout(t,i):(n=!1,e.hasPatchLayout=!0)));var o=t.views;if(this._saveLayout(o),n){for(var s in o)this._addView(s,i,o[s].type);this._apply(function(t,r){t._getRequestViews(e,o[r],i)})}return e},r.View.prototype.__patchLayout=function(e,t){e.views={};var n=this.patchLayout(t);r.View.assert(!!n,11);var o=r.layout.page(n,t);this.__checkPatchLayout(o),i.extend(e.views,o)},r.View.prototype.__checkPatchLayout=function(e){for(var t in e)r.View.assert(e[t].type===r.L.BOX,12)},r.View.prototype.__evaluateState=function(){this.asyncState=!1;var e=!0;return this.async?this.shouldBeSync||this.isModelsValid()?e=!0:(this.asyncState=!0,e=!1):(this.isValidSelf()||this.invalidate(),e=!0),this.shouldBeSync=!1,e},r.View.prototype.__registerInUpdate=function(e,t){e?t.sync.push(this):t.async.push(this)},r.View.prototype._getUpdateTree=function(e){return this.isValid()?this._apply(function(t){t._getUpdateTree(e)}):e.views[this.id]=this._getViewTree(),e},r.View.prototype._getCommonTree=function(){var e={box:this.info.isBox,collection:this.info.isCollection,id:this.id,key:this.key,models:{},params:this.params,state:this.asyncState?"loading":"ok",tree:{},uniqueId:this.__uniqueId,views:{}};return e.tree[this.id]=!0,e},r.View.prototype._getTree=function(){var e=this._getCommonTree(),t=this.patchTree(e);return t&&"object"==typeof t&&!Array.isArray(t)&&(e=i.extend(t,e)),e},r.View.prototype._getViewTree=function(){var e=this._getTree();return e.models=this._getModelsForTree(),"loading"===e.state?e:(this.isModelsValid()?e.views=this._getDescViewTree():e.state="error",e)},r.View.prototype.patchTree=i.nop,r.View.prototype._getDescViewTree=function(){var e={};return this._apply(function(t,i){e[i]=t._getViewTree()}),e},r.View.prototype._getPlaceholderTree=function(){var e=this._getTree();return e.state="placeholder",this.info.isCollection?e.views=this._getDescViewTree():this._apply(function(t){t._getUpdateTree(e)}),e},r.View.prototype._getModelsForTree=function(){var e={},t=this.models;for(var i in t){var r=t[i];e[i]={},r.isValid()?(e[i].status="ok",e[i][i]=r.getData()):(e[i].status="error",e[i][i]=r.getError())}return e},r.View.prototype.getModel=function(e){return this.models[e]},r.View.prototype.getModelData=function(e){return this.getModel(e).getData()},r.View.prototype._getDescendantsAndSelf=function(e){return e=e||[],e.push(this),this._apply(function(t){t._getDescendantsAndSelf(e)}),e},r.View.prototype._setNode=function(e){var t=this.STATUS;e?(this.node=e,this.$node=$(e),this.status=this.asyncState?t.LOADING:t.OK):this.status=t.NONE},r.View.prototype._extractNodeByKey=function(e){var t=e.querySelector('[data-key="'+this.key+'"]');if(!t)return null;var i=t.className;return-1===i.indexOf(this.__uniqueId)&&(t.className=i.replace(o,this.__uniqueId)),t},r.View.prototype._extractNode=function(e){var t=r.byClass(this.__uniqueId,e)[0];return t&&t.getAttribute("data-key")===this.key||(t=this._extractNodeByKey(e)),t},r.View.prototype._selfBeforeUpdateHTML=function(e,t){if(t){var i=this._visible===!0&&!this.isLoading();return i&&e["ns-view-hide"].push(this),void 0}var r=!this.isValidSelf();r&&this.node&&!this.isLoading()&&(this._visible===!0&&e["ns-view-hide"].push(this),e["ns-view-htmldestroy"].push(this))},r.View.prototype.beforeUpdateHTML=function(e,t){this._selfBeforeUpdateHTML(e,t),this.asyncState||this._apply(function(i){i.beforeUpdateHTML(e,t)})},r.View.prototype._updateHTML=function(e,t,n){var o;o=t.toplevel?i.extend({},t):t;var s,a=!this.isValid();a&&(s=this._extractNode(e),r.View.assert(!!s,6,[this.id]),t.toplevel&&(this.node&&(r.replaceNode(this.node,s),o.parent_added=!0),o.toplevel=!1),this.node&&!this.isLoading()&&(this.__onHide(),this.__onHtmldestroy()),!this.node||t.parent_added||o.parent_added||r.replaceNode(this.node,s),this._setNode(s),this.isOk()?this._htmlinit(n["ns-view-htmlinit"]):this.isLoading()&&n["ns-view-async"].push(this),this._saveModelsVersions()),this.isOk()&&(this._show(n["ns-view-show"]),n["ns-view-touch"].push(this)),s=s||e,this.asyncState||this._apply(function(e){e._updateHTML(s,o,n)})},r.View.prototype._saveModelsVersions=function(){for(var e in this.models)this._saveModelVersion(e)},r.View.prototype._getModelVersion=function(e){return this.models[e].getVersion()},r.View.prototype._saveModelVersion=function(e){this._modelsVersions[e]=this._getModelVersion(e)},r.View.prototype.keepValid=r.View.prototype._saveModelsVersions,r.View.prototype.updateAfter=function(e,t,i){this._asyncPromise=new Vow.Promise;var r=this;return e.then(function(){r.update(t,{timers:i.getTimers()})}),this._asyncPromise},r.View.prototype.update=function(e,t){this.shouldBeSync=!0;var n=this.params;if(e&&(n=i.extend({},this.params,e)),!this.layout){var o="ns-temp-layout-for-"+this.id,s={};s[this.id]={},r.layout.define(o,s),this.layout=r.layout.page(o,n),r.layout.undefine(o)}t=t||{},t.execFlag=t.execFlag||r.U.EXEC.ASYNC;var a=new r.Update(this,this.layout,n,t).render();return this._asyncPromise&&this._asyncPromise.sync(a),a},r.View.prototype.destroy=function(){this._apply(function(e){e.destroy()}),this.trigger("ns-view-destroyed"),this.views={},this.node&&!this.isLoading()&&(this.isVisible()&&(this.trigger("ns-view-hide"),this.hideAndUnbindEvents()),this.trigger("ns-view-htmldestroy"),this.__onHtmldestroy()),this.__unbindModelsEvents(),this.node&&(this.$node.off().removeData().remove(),this.node=null,this.$node=null),this.info=null,this.layout=null,this.models=null,this.params=null,this.status=this.STATUS.NONE,this._modelsHandlers=null};var s={},a={};r.View.define=function(e,t,n){r.View.assert(!(e in s),1,[e]),t=t||{};var o=this;"string"==typeof n?(o=a[n],r.View.assert(!!o,2,[n,e])):"function"==typeof n&&(o=n);var l=t.ctor||function(){};return l=i.inherit(l,o,t.methods),t.models=this._formatModelsDecl(t.models||{}),t.events=t.events||{},t.isBox=!1,t.isCollection=!1,t.ready=!1,s[e]=t,a[e]=l,l},r.View._reset=function(){a={},s={}},r.View.infoLite=function(e){var t=s[e];return r.View.assert(!!t,3,[e]),t},r.View.info=function(e){var t=r.View.infoLite(e);return t.ready||(r.View._initInfoParams(t),r.View._initInfoEvents(t),t.ready=!0),t},r.View._initInfoParams=function(e){if(e.params){if(r.View.assert(!e["params+"],7),r.View.assert(!e["params-"],8),"function"==typeof e.params)return e.pGroups=[],void 0;var t,n=[];t=Array.isArray(e.params)?e.params:[e.params];for(var o=0;o<t.length;o++){var s=t[o];n.push({pNames:Object.keys(s),pFilters:s,pDefaults:{}})}e.pGroups=n}else{var a={};for(var l in e.models){var u=r.Model.info(l);r.View.assert(!!u,9,[l]),"object"==typeof u.params&&i.extend(a,u.params)}var p=e["params-"];if(p){for(var o=0;o<p.length;o++)delete a[p[o]];delete e["params-"]}e["params+"]&&(i.extend(a,e["params+"]),delete e["params+"]);var h=Object.keys(a);e.pGroups=h.length?[{pNames:h,pFilters:{},pDefaults:a}]:[]}},r.View._initInfoEvents=function(e){e.createEvents=[],e.initEvents={bind:[],delegate:[]},e.showEvents={bind:[],delegate:[]},e.initNsevents=[],e.showNsevents=[];for(var t in e.events){var i=t.split(" "),n=i.shift().split("@"),o=n.length>1?n.pop():"";o=!o||"init"!==o&&"show"!==o?"":o;var s=n.join("@"),a=i.join(" ");if(s){var l=e.events[t],u=r.V.DOM_EVENTS.indexOf(s)>-1;if(u){var p=[s,a,e.events[t]],h="window"===a||"document"===a,d=h||!("scroll"===s&&a);o||(o=h?"show":"init"),e[o+"Events"][d?"delegate":"bind"].push(p)}else r.V.NS_EVENTS.indexOf(s)>-1?e.createEvents.push([s,l]):(o=o||"show",e[o+"Nsevents"].push([s,l]))}}},r.View.getKey=function(e,t,i){return this.getKeyAndParams(e,t,i).key},r.View.getKeyAndParams=function(e,t,n){n=n||r.View.info(e)||{};var o;return o="function"==typeof n.params?n.params(i.extend({},t)):r.View._getKeyParams(e,t,n),"function"==typeof n.paramsRewrite&&(o=n.paramsRewrite(o)),r.View.assert(!!o,10,[e]),{params:o,key:r.key("view="+e,o)}},r.View._getKeyParams=function(e,t,n){var o={},s=!1;for(var a in n.models){var l=r.Model.info(a);"function"==typeof l.params&&(s=!0,i.extend(o,l.params(t)))}s&&(i.extend(o,t),t=o);var u=n.pGroups||[];if(!u.length)return s?t:{};for(var p=0;p<u.length;p++){for(var h=u[p],d=h.pNames||[],c=h.pFilters||{},f=h.pDefaults||{},v={},y=0,_=d.length;_>y;y++){var m=d[y],g=t[m],w=c[m],V=m in f;if(g=void 0===g?f[m]:g,null!=g||!V){if(null==g||w&&g!==w){v=null;break}v[m]=g}}if(v)return v}return null},r.View.create=function(e,t,i){var n=a[e];r.View.assert(!!n,3,[e]);var o=new n;return o._init(e,t,i),o},r.View.assert=function(e,t,i){if(!e){i=Array.isArray(i)?i:[];var n=["ns.View",r.View.ERROR_CODES[t]].concat(i);r.assert.fail.apply(r,n)}},r.View.ERROR_CODES={1:"Can't redefine '%s'",2:"Can't find '%s' to extend '%s'",3:"'%s' is not defined",4:"'%s' can't find handler '%s' for model '%s'",5:"Can't find method '%s' in '%s'",6:"Can't find node for '%s'",7:"you cannot specify params and params+ at the same time",8:"you cannot specify params and params- at the same time",9:"Model %s is not defined!",10:"Could not generate key for view %s",11:"#patchLayout MUST returns valid layout ID",12:"#patchLayout MUST returns layout with ns.Box at top"},r.View.defaultModelEvents={"ns-model-insert":"invalidate","ns-model-remove":"invalidate","ns-model-changed":"invalidate","ns-model-destroyed":"invalidate"},r.View._expandModelsDecl=function(e){if(!Array.isArray(e))return e;for(var t={},r=0,n=e.length;n>r;r++)t[e[r]]=i.extend({},this.defaultModelEvents);return t},r.View._formatModelsDecl=function(e){var t=this._expandModelsDecl(e);for(var i in t){var r=l(t[i]),n=null;"string"==typeof r&&(n=r,r={});for(var o in this.defaultModelEvents){var s=this.defaultModelEvents[o];r[o]=void 0===r[o]?n||s:l(r[o])}t[i]=r}return t};var l=function(e){return!0===e?"invalidate":!1===e?"keepValid":e}}(),r.ViewCollection=function(){},i.extend(r.ViewCollection,r.View),i.inherit(r.ViewCollection,r.View),r.ViewCollection.define=function(e,t,i){t=t||{},i=i||this;var n=r.View.define.call(this,e,t,i);if(r.assert(t.split,"ns.ViewCollection","'%s'  must define 'split' section",e),r.assert(!(t.split.intoViews&&t.split.intoLayouts),"ns.ViewCollection","'%s' can't define 'split.intoViews' and 'split.intoLayouts' sections at same time",e),"string"==typeof t.split.intoViews){var o=r.layout.generateSimple(t.split.intoViews,"ns-auto-layout-"+e);delete t.split.intoViews,t.split.intoLayouts=new Function("",'return "'+o+'"')}else"function"==typeof t.split.intoViews&&(t.split.intoLayouts=function(i,n){var o=t.split.intoViews.call(this,i,n);return o?r.layout.generateSimple(o,"ns-auto-layout-"+e):null});r.assert(t.split.intoLayouts,"ns.ViewCollection","'%s'  must define 'split.intoLayouts' section",e),r.assert(t.split.byModel,"ns.ViewCollection","'%s'  must define 'split.byModel' section",e);var s=t.split.byModel in t.models&&r.Model.infoLite(t.split.byModel).isCollection;return r.assert(s,"ns.ViewCollection","'%s'  must depend on ns.ModelCollection",e),t.isCollection=!0,t.modelCollectionId=t.split.byModel,n},r.ViewCollection.prototype.__customInit=function(){this.__itemsToRemove=[],this.__model2View={},this.__view2ModelKey={}},r.ViewCollection.eventsModelCollectionDefault={"ns-model-insert":"keepValid","ns-model-remove":"keepValid","ns-model-changed":"invalidate","ns-model-destroyed":"invalidate"},r.ViewCollection._expandModelsDecl=function(e){if(!Array.isArray(e))return e;for(var t={},n=0,o=e.length;o>n;n++){var s=e[n];t[s]=r.Model.infoLite(s).isCollection?i.extend({},this.eventsModelCollectionDefault):i.extend({},this.defaultModelEvents)}return t},r.ViewCollection.prototype._invokeModelHandler=function(e,t,i,r){return r&&r.model?void 0:(this._saveModelVersion(t.id),e.apply(this,Array.prototype.slice.call(arguments,2)))},r.ViewCollection.prototype._getModelVersion=function(e){var t,i=this.models[e];return t=e===this.info.modelCollectionId?i.getSelfVersion():i.getVersion()},r.ViewCollection.prototype.forEachItem=function(e){var t=this.models[this.info.modelCollectionId];if(t.isValid())for(var i=t.models,r=0,n=i.length;n>r;r++){var o=this.getItemByModel(i[r]);o&&e(o)}},r.ViewCollection.prototype.getItemByModel=function(e){var t=e.key;return this.__model2View[t]},r.ViewCollection.prototype.isValid=function(){return this.isValidSelf()&&this.isValidDesc()},r.ViewCollection.prototype.isValidDesc=function(){for(var e in this.views)if(!this.views[e].isValid())return!1;return!0},r.ViewCollection.prototype.invalidate=function(){this.status===this.STATUS.OK&&(this.status=this.STATUS.INVALID)},r.ViewCollection.prototype.invalidateAll=r.View.prototype.invalidate,r.ViewCollection.prototype._getView=function(e,t){var i=r.View.getKey(e,t);return this._getViewByKey(i)},r.ViewCollection.prototype._getViewByKey=function(e){return this.views&&this.views[e]||null},r.ViewCollection.prototype._addView=function(e,t,i){var n=this._getView(e,t);if(!n){n=r.View.create(e,t);var o=n.key,s=i.key;this.views[o]=n,this.__model2View[s]=n,this.__view2ModelKey[o]=s}return n},r.ViewCollection.prototype._deleteView=function(e){var t=e.key,i=this.__view2ModelKey[t];delete this.views[t],delete this.__model2View[i],delete this.__view2ModelKey[t]},r.ViewCollection.prototype._apply=function(e){var t=this.views;for(var i in t)e(t[i],t[i].id)},r.ViewCollection.prototype._getRequestViews=function(e,t,n){var o=t.views,s=this.__evaluateState();if(this.__registerInUpdate(s,e),s){var a=this.models[this.info.modelCollectionId],l={};if(a.isValid()){for(var u=a.models,p=this.info.split.intoLayouts,h=[],d=0,c=u.length;c>d;d++){var f=u[d],v=i.extend({},n,f.params),y=p.call(this,f,v);if(y){var _=r.layout.page(y,v);h.push(_);for(var m in _){var g=this._addView(m,v,f);g._getRequestViews(e,_[m],v),l[g.key]=null}}}o["ns-view-container"]=h,this.__collectInactiveViews(l)}else e.hasPatchLayout=!0}return this._saveLayout(o),e},r.ViewCollection.prototype.__collectInactiveViews=function(e){var t=this;this._apply(function(i){i.key in e||(t._deleteView(i),t.__itemsToRemove.push(i))})},r.ViewCollection.prototype.__destroyInactiveViews=function(){for(var e=this.__itemsToRemove,t=0,i=e.length;i>t;t++)e[t].destroy();this.__itemsToRemove=[]},r.ViewCollection.prototype._getUpdateTree=function(e){var t;return t=this.isValidSelf()?this._getPlaceholderTree():this._getViewTree(),e.views[this.id]=t,e},r.ViewCollection.prototype._getDescViewTree=function(){var e={};e["ns-view-collection-container"]=[];var t=this.isValidSelf();return this.forEachItem(function(i){var r=null;if(t)if(i.info.isCollection&&i.isValidSelf())r=i._getPlaceholderTree();else if(i.isValid()){if(!i.isValidWithDesc()){var n={views:{}};return i._getUpdateTree(n),e["ns-view-collection-container"].push(n.views),void 0}}else r=i._getViewTree();else r=i.isValidSelf()?i._getPlaceholderTree():i._getViewTree();if(r){var o={};o[i.id]=r,e["ns-view-collection-container"].push(o)}}),e},r.ViewCollection.prototype._updateHTML=function(e,t,n){var o,s=this._extractNode(e),a=$(s).hasClass("ns-view-placeholder");if(o=t.toplevel?i.extend({},t):t,this.isValidSelf())!t.toplevel&&a&&(r.replaceNode(s,this.node),o=i.extend({},t),o.toplevel=!0,o.parent_added=!0);else{var l=!!this.node;if(!s)throw new Error("[ns.ViewCollection] Can't find node for '"+this.id+"'");t.toplevel?a?o.toplevel=!0:(this.node&&r.replaceNode(this.node,s),o.toplevel=!1,o.parent_added=!0,this._setNode(s)):a?(r.replaceNode(s,this.node),o.toplevel=!1,o.parent_added=!0):this._setNode(s),l&&!this.isLoading()&&(this.__onHide(),this.__onHtmldestroy()),this.isOk()?this._htmlinit(n["ns-view-htmlinit"]):this.isLoading()&&n["ns-view-async"].push(this)}if(this.isOk()&&(this._show(n["ns-view-show"]),n["ns-view-touch"].push(this),this._saveModelsVersions()),!this.isLoading()){var u={},p=this.__getContainer();s=s||this.node;var h;this.forEachItem(function(e){if(a){var t=!e.isValid();e._updateHTML(s,o,n),t&&(h?$(h.node).after(e.node):$(p).prepend(e.node))}else{var l=e.isValid(),d=o;l&&(d=i.extend({},o),d.toplevel=!0),e._updateHTML(s,d,n),l&&r.replaceNode(e._extractNode(s),e.node)}u[e.key]=e,h=e}),this.__sortViewItems()}this.__destroyInactiveViews()},r.ViewCollection.prototype.__getContainer=function(){var e;return e=r.hasClass(this.node,"ns-view-container-desc")?this.node:r.byClass("ns-view-container-desc",this.node)[0],r.assert(e,"ns.ViewCollection","Can't find descendants container (.ns-view-container-desc element) for '"+this.id+"'"),e},r.ViewCollection.prototype.__sortViewItems=function(){var e=this.__getContainer(),t=r.childrenIterator(e);this.forEachItem(function(i){var r=t.getNext();r!==i.node&&(r?e.insertBefore(i.node,r):e.appendChild(i.node))})},r.Box=function(e,t){this.id=e,this.__setUniqueId(),this.params=t,this.views={},this.key=r.Box.getKey(e),this.node=null,this.active={},this._visible=!1,this.info={isBox:!0,isCollection:!1}},r.Box.prototype._getViewKey=function(e,t,i){var n;return n=i===r.L.BOX?r.Box.getKey(e):r.View.getKey(e,t)},r.Box.prototype._getView=function(e,t,i){var r=this._getViewKey(e,t,i);return this.views[r]},r.Box.prototype._addView=function(e,t,i){var n=this._getView(e,t,i);return n||(n=i===r.L.BOX?new r.Box(e,t):r.View.create(e,t,i===r.L.ASYNC),this.views[n.key]=n),n},r.Box.prototype._getDescendantsAndSelf=function(e){var t=this.views;e.push(this);for(var i in t){var r=t[i];r._getDescendantsAndSelf(e)}return e},r.Box.prototype._getRequestViews=function(e,t,i){var r=t.views,n={};for(var o in r){var s=r[o],a=this._addView(o,i,s.type);a._getRequestViews(e,s,i),n[o]=a.key}this.active=n},r.Box.prototype._getUpdateTree=function(e){if(this.isNone())e.views[this.id]=this._getViewTree();else for(var t in this.active){var i=this.active[t];this.views[i]._getUpdateTree(e)}},r.Box.prototype._getViewTree=function(){var e=this._getCommonTree();for(var t in this.active){var i=this.active[t];e.views[t]=this.views[i]._getViewTree()}return e},r.Box.prototype.beforeUpdateHTML=function(e,t){for(var i in this.views){var r=this.views[i],n=t||this.active[r.id]!==r.key;r.beforeUpdateHTML(e,n)}},r.Box.prototype._hideInactiveViews=function(){for(var e in this.views){var t=this.views[e];if(this.active[t.id]!==t.key){t.node&&r.removeNode(t.node);for(var i=t._getDescendantsAndSelf([]),n=0,o=i.length;o>n;n++)i[n].hideAndUnbindEvents()}}},r.Box.prototype._updateHTML=function(e,t,i){var n;if(!this.node||!t.toplevel){var o=r.byClass("ns-view-"+this.id,e)[0];o&&(n=this.node,this.node=o,this._visible=!1)}if(!this.node)throw new Error("[ns.Box] Can't find node for '"+this.id+"'");this._hideInactiveViews();var s=this.views,a=this.active;for(var l in a){var u=a[l],p=s[u];p._updateHTML(e,t,i)}this._transferViewsToNewNode(n),this._sortViewNodes(),this._show()},r.Box.prototype._sortViewNodes=function(){var e=this.active,t=this.views,i=r.childrenIterator(this.node);for(var n in e){var o=e[n],s=t[o],a=i.getNext();a!==s.node&&(a?this.node.insertBefore(s.node,a):this.node.appendChild(s.node))}},r.Box.prototype._transferViewsToNewNode=function(e){if(e){var t=this.views;for(var i in t){var r=t[i];if(this.active[r.id]!==r.key){var n=r.node;e.contains(n)&&this.node.appendChild(n)}}}},r.Box.prototype._show=function(){return this._visible===!1&&(this._visible=!0),!1},r.Box.prototype.hideAndUnbindEvents=function(){this._visible===!0&&(this._visible=!1)},r.Box.prototype.isNone=function(){return!this.node},r.Box.prototype.isValid=function(){return!!this.node},r.Box.prototype.destroy=function(){var e=this.views;for(var t in e)e[t].destroy();this.node&&($(this.node).off().removeData().remove(),this.node=null,this.$node=null),this.active=null,this.key=null,this.params=null,this.views=null,this._visible=!1},r.Box.prototype.__setUniqueId=r.View.prototype.__setUniqueId,r.Box.prototype._getCommonTree=r.View.prototype._getCommonTree,r.Box.prototype.isValidWithDesc=r.View.prototype.isValidWithDesc,r.Box.prototype.isOk=i.true,r.Box.prototype.isLoading=i.false,r.Box.getKey=function(e){return"box="+e},e.no=i,e.ns=r}(window,document);